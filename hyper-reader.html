<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“–</text></svg>">
  <title>Text Reader</title>
  <style>
    @font-face {
      font-family: Reader1;
      src: local('LMRoman12-Regular'), url('https://mirror.kku.ac.th/CTAN/fonts/lm/fonts/opentype/public/lm/lmroman12-regular.otf') format('opentype');
    }
    @font-face {
      font-family: Reader;
      font-weight: 400;
      src: local('WorkSans-Regular');
    }
    @font-face {
      font-family: Reader;
      font-weight: 500;
      src: local('WorkSans-Medium');
    }

    /** reset **/
    * {
      box-sizing: border-box;
      padding: 0;
      margin: 0;
      border: 0;
      outline: 0;
      transform-origin: 50% 50%;
    }
    p {
      margin: 1em 0;
    }
    hr {
      border: 0;
      height: 1px;
      background: rgba(0, 0, 0, .2);
    }
    a,
    a:any-link {
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-decoration-skip-ink: none;
      text-underline-offset: 4px;
      cursor: pointer;
    }
    small {
      font-size: 0.875em;
    }

    /** rose pine **/
    :root {
      --rp-main-base: #191724;
      --rp-main-surface: #1f1d2e;
      --rp-main-overlay: #26233a;
      --rp-main-muted: #6e6a86;
      --rp-main-subtle: #908caa;
      --rp-main-text: #e0def4;
      --rp-main-love: #eb6f92;
      --rp-main-gold: #f6c177;
      --rp-main-rose: #ebbcba;
      --rp-main-pine: #31748f;
      --rp-main-foam: #9ccfd8;
      --rp-main-iris: #c4a7e7;
      --rp-main-highlight-low: #21202e;
      --rp-main-highlight-low-alpha: #6e6a861a;
      --rp-main-highlight-med: #403d52;
      --rp-main-highlight-med-alpha: #6e6a8633;
      --rp-main-highlight-high: #524f67;
      --rp-main-highlight-high-alpha: #6e6a8666;
      --rp-moon-base: #232136;
      --rp-moon-surface: #2a273f;
      --rp-moon-overlay: #393552;
      --rp-moon-muted: #6e6a86;
      --rp-moon-subtle: #908caa;
      --rp-moon-text: #e0def4;
      --rp-moon-love: #eb6f92;
      --rp-moon-gold: #f6c177;
      --rp-moon-rose: #ea9a97;
      --rp-moon-pine: #3e8fb0;
      --rp-moon-foam: #9ccfd8;
      --rp-moon-iris: #c4a7e7;
      --rp-moon-highlight-low: #2a283e;
      --rp-moon-highlight-low-alpha: #817c9c14;
      --rp-moon-highlight-med: #44415a;
      --rp-moon-highlight-med-alpha: #817c9c26;
      --rp-moon-highlight-high: #56526e;
      --rp-moon-highlight-high-alpha: #817c9c4d;
      --rp-dawn-base: #faf4ed;
      --rp-dawn-surface: #fffaf3;
      --rp-dawn-overlay: #f2e9e1;
      --rp-dawn-muted: #9893a5;
      --rp-dawn-subtle: #797593;
      --rp-dawn-text: #575279;
      --rp-dawn-love: #b4637a;
      --rp-dawn-gold: #ea9d34;
      --rp-dawn-rose: #d7827e;
      --rp-dawn-pine: #286983;
      --rp-dawn-foam: #56949f;
      --rp-dawn-iris: #907aa9;
      --rp-dawn-highlight-low: #f4ede8;
      --rp-dawn-highlight-low-alpha: #6e6a860d;
      --rp-dawn-highlight-med: #dfdad9;
      --rp-dawn-highlight-med-alpha: #6e6a8614;
      --rp-dawn-highlight-high: #cecacd;
      --rp-dawn-highlight-high-alpha: #6e6a8626;
    }

    /** variables **/
    :root {
      --nav-width: 300px;
      --aside-width: 60px;
      --gap: 1rem;
      --paper-padding: calc(var(--gap) * 3);
      cursor: default;
    }
    .settings .colors button.white {
      --body-font-color: rgb(27, 27, 27);
      --body-background-color: rgb(230, 230, 230);
      --paper-background-color: rgb(255, 255, 255);
      /*--paper-shadow-color: rgba(0, 0, 0, .2); */
      --link-color: rgb(65, 110, 210);
      --horizontal-line-color: rgb(220, 220, 220);
    }
    :root[data-color\:light=white] {
      @media (prefers-color-scheme:light) {
        --body-font-color: rgb(27, 27, 27);
        --body-background-color: rgb(230, 230, 230);
        --paper-background-color: rgb(255, 255, 255);
        /*--paper-shadow-color: rgba(0, 0, 0, .2); */
        --link-color: rgb(65, 110, 210);
        --horizontal-line-color: rgb(220, 220, 220);
      }
    }
    :root[data-color\:dark=white] {
      @media (prefers-color-scheme:dark) {
        --body-font-color: rgb(27, 27, 27);
        --body-background-color: rgb(230, 230, 230);
        --paper-background-color: rgb(255, 255, 255);
        /*--paper-shadow-color: rgba(0, 0, 0, .2); */
        --link-color: rgb(65, 110, 210);
        --horizontal-line-color: rgb(220, 220, 220);
      }
    }
    .settings .colors button.sepia {
      --body-font-color: rgb(79, 50, 28);
      --body-background-color: rgb(225, 216, 200);
      --paper-background-color: rgb(248, 241, 227);
      /*--paper-shadow-color: rgba(0, 0, 0, .2); */
      --link-color: rgb(209, 150, 0);
      --horizontal-line-color: rgb(230, 218, 201);
    }
    :root[data-color\:light=sepia] {
      @media (prefers-color-scheme:light) {
        --body-font-color: rgb(79, 50, 28);
        --body-background-color: rgb(225, 216, 200);
        --paper-background-color: rgb(248, 241, 227);
        /*--paper-shadow-color: rgba(0, 0, 0, .2); */
        --link-color: rgb(209, 150, 0);
        --horizontal-line-color: rgb(230, 218, 201);
      }
    }
    :root[data-color\:dark=sepia] {
      @media (prefers-color-scheme:dark) {
        --body-font-color: rgb(79, 50, 28);
        --body-background-color: rgb(225, 216, 200);
        --paper-background-color: rgb(248, 241, 227);
        /*--paper-shadow-color: rgba(0, 0, 0, .2); */
        --link-color: rgb(209, 150, 0);
        --horizontal-line-color: rgb(230, 218, 201);
      }
    }
    .settings .colors button.gray {
      --body-font-color: rgba(255, 255, 255, 0.78);
      --body-background-color: rgb(50, 50, 51);
      --paper-background-color: rgb(74, 74, 77);
      /*--paper-shadow-color: rgba(0, 0, 0, .24); */
      --link-color: rgb(90, 200, 250);
      --horizontal-line-color: rgb(111, 111, 111);
      --body-font-smoothing: antialiased;
    }
    :root[data-color\:light=gray] {
      @media (prefers-color-scheme:light) {
        --body-font-color: rgba(255, 255, 255, 0.78);
        --body-background-color: rgb(50, 50, 51);
        --paper-background-color: rgb(74, 74, 77);
        /*--paper-shadow-color: rgba(0, 0, 0, .24); */
        --link-color: rgb(90, 200, 250);
        --horizontal-line-color: rgb(111, 111, 111);
        --body-font-smoothing: antialiased;
      }
    }
    :root[data-color\:dark=gray] {
      @media (prefers-color-scheme:dark) {
        --body-font-color: rgba(255, 255, 255, 0.78);
        --body-background-color: rgb(50, 50, 51);
        --paper-background-color: rgb(74, 74, 77);
        /*--paper-shadow-color: rgba(0, 0, 0, .24); */
        --link-color: rgb(90, 200, 250);
        --horizontal-line-color: rgb(111, 111, 111);
        --body-font-smoothing: antialiased;
      }
    }
    .settings .colors button.night {
      --body-font-color: rgb(176, 176, 176);
      --body-background-color: rgb(0, 0, 0);
      --paper-background-color: rgb(18, 18, 18);
      --paper-outline-color: #272727;
      --link-color: rgb(90, 200, 250);
      --horizontal-line-color: rgb(62, 62, 62);
      --body-font-smoothing: antialiased;
    }
    :root[data-color\:light=night] {
      @media (prefers-color-scheme:light) {
        --body-font-color: rgb(176, 176, 176);
        --body-background-color: rgb(0, 0, 0);
        --paper-background-color: rgb(18, 18, 18);
        --paper-outline-color: #272727;
        --link-color: rgb(90, 200, 250);
        --horizontal-line-color: rgb(62, 62, 62);
        --body-font-smoothing: antialiased;
      }
    }
    :root[data-color\:dark=night] {
      @media (prefers-color-scheme:dark) {
        --body-font-color: rgb(176, 176, 176);
        --body-background-color: rgb(0, 0, 0);
        --paper-background-color: rgb(18, 18, 18);
        --paper-outline-color: #272727;
        --link-color: rgb(90, 200, 250);
        --horizontal-line-color: rgb(62, 62, 62);
        --body-font-smoothing: antialiased;
      }
    }
    .settings .colors button.rose-pine {
      --body-font-color: var(--rp-main-subtle);
      --body-background-color: var(--rp-main-surface);
      --paper-background-color: var(--rp-main-base);
      --paper-outline-color: var(--rp-main-highlight-med-alpha);
      --link-color: var(--rp-main-pine);
      --horizontal-line-color: var(--rp-main-highlight-high-alpha);
      --selection-bg: var(--rp-main-highlight-med);
      --body-font-smoothing: antialiased;
    }
    :root[data-color\:light=rose-pine] {
      @media (prefers-color-scheme:light) {
        --body-font-color: var(--rp-main-subtle);
        --body-background-color: var(--rp-main-surface);
        --paper-background-color: var(--rp-main-base);
        --paper-outline-color: var(--rp-main-highlight-med-alpha);
        --link-color: var(--rp-main-pine);
        --horizontal-line-color: var(--rp-main-highlight-high-alpha);
        --selection-bg: var(--rp-main-highlight-med);
        --body-font-smoothing: antialiased;
      }
    }
    :root[data-color\:dark=rose-pine] {
      @media (prefers-color-scheme:dark) {
        --body-font-color: var(--rp-main-subtle);
        --body-background-color: var(--rp-main-surface);
        --paper-background-color: var(--rp-main-base);
        --paper-outline-color: var(--rp-main-highlight-med-alpha);
        --link-color: var(--rp-main-pine);
        --horizontal-line-color: var(--rp-main-highlight-high-alpha);
        --selection-bg: var(--rp-main-highlight-med);
        --body-font-smoothing: antialiased;
      }
    }
    .settings .colors button.rose-pine-moon {
      --body-font-color: var(--rp-moon-subtle);
      --body-background-color: var(--rp-moon-surface);
      --paper-background-color: var(--rp-moon-base);
      --paper-outline-color: var(--rp-moon-highlight-med-alpha);
      --link-color: var(--rp-moon-rose);
      --horizontal-line-color: var(--rp-moon-highlight-high-alpha);
      --selection-bg: var(--rp-moon-highlight-med);
      --body-font-smoothing: antialiased;
    }
    :root[data-color\:light=rose-pine-moon] {
      @media (prefers-color-scheme:light) {
        --body-font-color: var(--rp-moon-subtle);
        --body-background-color: var(--rp-moon-surface);
        --paper-background-color: var(--rp-moon-base);
        --paper-outline-color: var(--rp-moon-highlight-med-alpha);
        --link-color: var(--rp-moon-rose);
        --horizontal-line-color: var(--rp-moon-highlight-high-alpha);
        --selection-bg: var(--rp-moon-highlight-med);
        --body-font-smoothing: antialiased;
      }
    }
    :root[data-color\:dark=rose-pine-moon] {
      @media (prefers-color-scheme:dark) {
        --body-font-color: var(--rp-moon-subtle);
        --body-background-color: var(--rp-moon-surface);
        --paper-background-color: var(--rp-moon-base);
        --paper-outline-color: var(--rp-moon-highlight-med-alpha);
        --link-color: var(--rp-moon-rose);
        --horizontal-line-color: var(--rp-moon-highlight-high-alpha);
        --selection-bg: var(--rp-moon-highlight-med);
        --body-font-smoothing: antialiased;
      }
    }
    .settings .colors button.rose-pine-dawn {
      --body-font-color: var(--rp-dawn-text);
      --body-background-color: var(--rp-dawn-base);
      --paper-background-color: var(--rp-dawn-overlay);
      --paper-outline-color: var(--rp-dawn-highlight-med);
      --link-color: var(--rp-dawn-love);
      --horizontal-line-color: var(--rp-dawn-highlight-high);
      --selection-bg: var(--rp-dawn-highlight-med);
    }
    :root[data-color\:light=rose-pine-dawn] {
      @media (prefers-color-scheme:light) {
        --body-font-color: var(--rp-dawn-text);
        --body-background-color: var(--rp-dawn-base);
        --paper-background-color: var(--rp-dawn-overlay);
        --paper-outline-color: var(--rp-dawn-highlight-med);
        --link-color: var(--rp-dawn-love);
        --horizontal-line-color: var(--rp-dawn-highlight-high);
        --selection-bg: var(--rp-dawn-highlight-med);
      }
    }
    :root[data-color\:dark=rose-pine-dawn] {
      @media (prefers-color-scheme:dark) {
        --body-font-color: var(--rp-dawn-text);
        --body-background-color: var(--rp-dawn-base);
        --paper-background-color: var(--rp-dawn-overlay);
        --paper-outline-color: var(--rp-dawn-highlight-med);
        --link-color: var(--rp-dawn-love);
        --horizontal-line-color: var(--rp-dawn-highlight-high);
        --selection-bg: var(--rp-dawn-highlight-med);
      }
    }

    :root,
    :root[data-paper-size=sm] { --paper-width: 90ex; }
    :root[data-paper-size=md] { --paper-width: 120ex; }
    :root[data-paper-size=lg] { --paper-width: 160ex; }
    :root[data-paper-size=xl] { --paper-width: 100%; }

    *::selection {
      background-color: var(--selection-bg);
    }

    /** layout **/
    body {
      display: grid;
      grid-template-columns: minmax(var(--nav-width), 1fr) minmax(auto, calc(var(--paper-width) + 2*var(--paper-padding))) minmax(var(--aside-width), 1fr);
    }

    /** global **/
    html,
    body {
      font: 16pt/1.4 Reader;
      color: var(--body-font-color);
      background: var(--body-background-color);
      font-variant-numeric: oldstyle-nums tabular-nums slashed-zero;
      -webkit-font-smoothing: var(--body-font-smoothing, normal);
    }
    a {
      color: var(--link-color);
    }

    @property --scroll-progress {
      syntax: '<percentage>';
      initial-value: 100%;
      inherits: false;
    }
    @keyframes scrollProgress {
      0% {
        --scroll-progress: 0%;
      }
      100% {
        --scroll-progress: 100%;
      }
    }

    /** nav **/
    nav {
      height: 100vh;
      overflow-y: auto;
      overscroll-behavior-y: contain;
      position: sticky;
      top: 0;
      padding: calc(var(--gap) * 0.75);
      font-size: 0.875rem;
      line-height: 1.2;
      ol {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 0.5em;
        align-items: start;
        li {
          /**/
          max-width: 100%;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          /**/
          padding-top: 0.1ex;
          padding-bottom: 0.1ex;
          padding-left: calc(var(--gap) * 0.25);
          padding-right: calc(var(--gap) * 0.25);
          &.active {
            background: var(--body-font-color);
            outline: calc(var(--gap) * 0.15) solid var(--body-font-color);
            border-radius: 0.5ex;
            color: var(--body-background-color);
            a {
              pointer-events: none;
              color: inherit;
            }
          }
          a {
            color: var(--body-font-color);
            &:hover {
              color: var(--link-color);
            }
          }
          &:first-child a {
            font-weight: bold;
          }
        }
      }
    }

    /** aside **/
    aside {
      position: sticky;
      top: 0;
      height: 100vh;
    }
    aside a,
    aside button {
      appearance: none;
      background: var(--paper-background-color);
      color: var(--body-font-color);
      outline: 1px solid var(--horizontal-line-color);
      width: 100%;
      min-width: 25px;
      aspect-ratio: 1;
      display: grid;
      place-content: center;
      border-radius: 50%;
      cursor: pointer;
    }
    aside > div {
      padding-top: var(--gap);
      padding-bottom: var(--gap);
      padding-left: var(--gap);
      padding-right: var(--gap);
      display: flex;
      flex-direction: column;
      row-gap: calc(var(--gap) * .5);
      width: var(--aside-width);
    }
    aside > div + div {
      position: relative;
    }
    aside > div + div::before {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translate3d(-50%, 0, 0);
      content: '';
      display: block;
      width: calc(var(--gap) * 2);
      height: 1px;
      background: var(--horizontal-line-color);
      opacity: 0.5;
    }
    aside .colors button {
      &::before {
        content: var(--checkmark);
        font-size: .7em;
      }
      @media (prefers-color-scheme:light) {
        &.checked\:light {
          --checkmark: 'âœ”';
        }
      }
      @media (prefers-color-scheme:dark) {
        &.checked\:dark {
          --checkmark: 'âœ”';
        }
      }
    }
    aside a.close {
      position: relative;
      box-shadow: 0 3px 6px rgba(0, 0, 0, .2);
      &::before,
      &::after {
        content: '';
        display: block;
        width: 50%;
        height: 1px;
        transform: translate3d(-50%, -50%, 0) rotateZ(var(--rotate, 45deg));
        position: absolute;
        top: 50%;
        left: 50%;
        background: currentColor;
      }
      &::after {
        --rotate: -45deg;
      }

      outline: 0;
      background: radial-gradient(closest-side, var(--paper-background-color) 79%, transparent 80% 100%), conic-gradient(var(--link-color) var(--scroll-progress, 0%), var(--horizontal-line-color) 0);
      animation: scrollProgress auto linear;
      animation-timeline: scroll();
    }
    aside button.refresh {
      box-shadow: 0 3px 6px rgba(0, 0, 0, .2);
      &::after {
        content: 'â†»';
        font-size: 1rem;
        position: relative;
        top: -1px;
      }
    }
    aside .paper-size button {
      border-radius: 0.75ex;
      outline-width: 0;
      &.selected {
        font-weight: bold;
      }
    }
    aside button.zen {
      border-radius: 0.75ex;
      outline-width: 0;
      &::after {
        content: 'â„¤';
      }
    }
    aside button.names-editor {
      border-radius: 0.75ex;
      outline-width: 0;
      &::after {
        content: 'â„•';
      }
    }

    /** main **/
    main {
      /**
      padding-top: var(--gap);
      padding-bottom: var(--gap);
      /**/
      display: flex;
      background: var(--paper-background-color);
      padding: 1rem 3rem;
      outline: 1px solid var(--paper-outline-color, transparent);
      box-shadow: 0px 6px 12px 3px var(--paper-shadow-color, transparent);
      article {
        flex: 1;
        text-indent: 3ch;
        max-width: var(--paper-width, 90ex);
        margin: 0 auto;
        p:first-child {
          line-height: 1.2;
          font-size: 1.5rem;
          font-weight: bold;
        }
        hr {
          background: var(--horizontal-line-color);
        }

        ::highlight(name) {
          color: var(--link-color);
        }
      }
    }

    /** table **/
    .table {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      row-gap: var(--gap);
      column-gap: calc(var(--gap) * 2);
      padding: 0 var(--gap) var(--gap);
      background: var(--paper-background-color);
      box-shadow: 0px 6px 12px 3px var(--paper-shadow-color);
      outline: 1px solid var(--paper-outline-color);
      line-height: 1.2;
      align-self: stretch;
      align-content: start;
    }
    .table .name {
      font-weight: bold;
    }
    .table .th {
      white-space: nowrap;
      padding: calc(var(--gap)/2) 0;
      position: sticky;
      top: 0;
      background: var(--paper-background-color);
    }
    .table .th::before {
      content: '';
      display: block;
      border-bottom: 1px solid var(--horizontal-line-color);
      width: calc(100% + 1ex);
      height: calc(2ex + 2px);
      box-shadow: 0 calc(1ex - 5px) 1.4ex -1ex rgba(0, 0, 0, .5);
      position: absolute;
      bottom: -1px;
      left: calc(-1ex / 2);
    }
    .table .th span {
      display: inline-block;
      position: relative;
    }
    .table .th span::after {
      position: absolute;
      bottom: calc(1ex/4);
      right: -1.8ex;
      color: var(--body-font-color);
    }
    .table .th[data-sort=asc] span::after { content: 'â†‘'; }
    .table .th[data-sort=desc] span::after { content: 'â†“'; }
    .table .desc { display: block; }
    .table .delete { color: inherit; }
    .table .delete:hover { color: var(--link-color); }

    /** disable scroll when mouse is not over **/
    /**
    nav,
    main {
      height: 100%;
      overflow-y: hidden;
    }
    nav:hover,
    main:hover {
      overflow-y: auto;
    }
    /**/

    /** zen mode **/
    [data-zen=true] nav {
      opacity: 0;
      transition: opacity .15s ease-in-out;
      &:hover {
        opacity: 1;
      }
    }

    /** command palette **/
    #command-palette[open] {
      --width: calc(var(--paper-width) - 80px);
      width: var(--width);
      max-height: 70%;
      position: fixed;
      top: 10%;
      left: calc((100% - var(--width)) / 2);
      border-radius: 1.5ex;
      overflow: hidden;
      box-shadow: 0 10px 20px rgba(0,0,0,.2);
      border: 1px solid var(--horizontal-line-color);
      background: var(--body-background-color);
      display: flex;
      flex-direction: column;
      padding: 0.7ex;

      form {
        display: contents;

        input {
          background: var(--paper-background-color);
          font-size: inherit;
          padding: 1ex 1.3ex;
          border: 1px solid var(--paper-outline-color);
          border-radius: 0.8ex;
          color: var(--body-font-color);
        }
      }

      ul {
        list-style: none;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        overscroll-behavior-y: contain;
        position: relative;
        margin-top: 0.7ex;
        gap: 1px;

        li {
          a {
            display: block;
            padding: 0.5ex 1.3ex;
            border-radius: 0.8ex;
            color: var(--body-font-color);
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }

          &:hover,
          &.selected {
            a {
              background: var(--paper-background-color);
            }
          }

          ::highlight(match) {
            background: yellow;
          }
        }
      }
    }

    /** names editor **/
    #names-editor[open] {
      --width: calc(var(--paper-width) - 80px);
      width: var(--width);
      height: 80%;
      position: fixed;
      top: 10%;
      left: calc((100% - var(--width)) / 2);
      border-radius: 1.5ex;
      overflow: hidden;
      box-shadow: 0 10px 20px rgba(0,0,0,.2);
      border: 1px solid var(--horizontal-line-color);
      background: var(--body-background-color);
      display: flex;
      flex-direction: column;
      gap: 0.7ex;
      padding: 0.7ex;

      form {
        display: contents;

        textarea {
          background: var(--paper-background-color);
          font-size: inherit;
          padding: 1ex 1.3ex;
          border: 1px solid var(--paper-outline-color);
          border-radius: 0.8ex;
          color: var(--body-font-color);
          flex: 1;
        }

        button {
          appearance: none;
          background: transparent;
          /**
          &:hover,
          &:focus,
          &:active {
            background: var(--paper-background-color);
          }
          /**/
          color: var(--body-font-color);
          width: 100%;
          min-width: 25px;
          display: grid;
          place-content: center;
          border-radius: 0.8ex;
          cursor: pointer;
          font-size: inherit;
          line-height: 1.8;
        }
      }
    }

    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .indent-none { text-indent: 0; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script type="module">
    import { h, text, app } from 'https://cdn.jsdelivr.net/npm/hyperapp/+esm';
    import { openDB } from 'https://cdn.jsdelivr.net/npm/idb/+esm';
    import { generateColor as stc } from 'https://cdn.jsdelivr.net/npm/@marko19907/string-to-color/+esm'
    import _ from 'https://cdn.jsdelivr.net/npm/lodash-es/+esm'

    class HashRouter extends EventTarget {
      parse(hash) {
        return [...(new URLSearchParams(hash)).entries()].reduce((route, [k, v]) => (route[k] = v, route), {});
      }
      get(key) {
        return new URLSearchParams(location.hash.slice(1)).get(key);
      }
      current() {
        return this.parse(location.hash.slice(1));
      }
      route(route) {
        let hash = new URLSearchParams(Object.entries(route).filter(([k, v]) => v !== '' && v != null)).toString();
        if (hash) hash = '#' + hash;
        return hash;
      }
      push(to) {
        let from = this.current();
        let allKeys = Object.keys({ ...from, ...to });
        let changed = allKeys.some(key => from[key] != to[key]);
        if (changed) {
          let url = new URL(location.href);
          url.hash = this.route(to);
          history.pushState(null, null, url);
        }
      }
      replace(to) {
        let from = this.current();
        let allKeys = Object.keys({ ...from, ...to });
        let changed = allKeys.some(key => from[key] != to[key]);
        if (changed) {
          let url = new URL(location.href);
          url.hash = this.route(to);
          history.replaceState(null, null, url);
        }
      }
    }

    let InitDbDone = (state, { db }) => [
      { ...state, db },
      (dispatch) => {
        window.db = db;
        dispatch(LoadSettings);
        dispatch(LoadProgress);
        dispatch(LoadRecentBooks);
        dispatch(LoadRecentBook);
      }
    ];
    let InitDb = (state) => [
      state,
      async (dispatch) => {
        let db = await openDB('text-reader', 23, {
          upgrade(db, oldVersion, newVersion, transaction, events) {
            console.log('upgrade db', { oldVersion, newVersion, transaction, events });
            let schemas = {
              files: {},
              fileContents: {},
              settings: {},
              progress: {},
              books: {},
              chapters: {},
              names: {},
            };
            for (let [store, keyOptions] of Object.entries(schemas)) {
              if (!db.objectStoreNames.contains(store)) {
                db.createObjectStore(store, keyOptions);
              }
            }
            //for(let store of db.objectStoreNames) {
            //  if (!(store in schemas)) {
            //    console.warn('Delete store', store);
            //    db.deleteObjectStore(store);
            //  }
            //}
          },
          blocked: console.log,
          blocking: console.log,
          terminated: console.log,
        });

        dispatch(InitDbDone, { db });
      }
    ];

    let InitTheme = (state) => [
      state,
      (dispatch) => {
        let colors = { 'color:dark': 'night', 'color:light': 'white' };
        dispatch(ApplySettings, colors);
      }
    ];

    let InitRouter = (state) => [
      state,
      (dispatch) => {
        addEventListener('hashchange', (event) => {
          let from = state.router.parse(new URL(event.oldURL).hash.slice(1));
          let to = state.router.parse(new URL(event.newURL).hash.slice(1));
          if (!to.book) {
            dispatch(ShowRecentBooks);
          } else {
            dispatch(OpenBook, { bookId: to.book, chapterId: to.chapter });
          }
        });
      }
    ];

    let InitKeyboardNavigator = (dispatch) => {
      let onKeyDown = (event) => {
        let formElements = ['INPUT', 'TEXTAREA', 'SELECT', 'OPTION'];
        if(formElements.includes(event.target.tagName)) return;

        switch(event.key) {
          case 'ArrowRight': dispatch(OpenNextChapter, +1); break;
          case 'ArrowLeft': dispatch(OpenNextChapter, -1); break;
          case 'Backspace': dispatch(ShowRecentBooks); break;
          default: break;
        }
      };
      addEventListener('keydown', onKeyDown);
      return () => removeEventListener('keydown', onKeyDown);
    };

    let InitCommandPalette = async (dispatch) => {
      onKey('Cmd+K', ToggleCommandPalette)(dispatch);
      onKey('Escape', [ToggleCommandPalette, { open: false }])(dispatch);

      await nextTick();
      let dialog = document.querySelector('#command-palette');
      onKey('ArrowUp', SelectPrevCommand, { target: dialog })(dispatch);
      onKey('ArrowDown', SelectNextCommand, { target: dialog })(dispatch);
    };

    let ToggleCommandPalette = (state, options) => {
      let open = options?.open != null ? !!options.open : !state.commandPalette.open;
      return [
        {
          ...state,
          commandPalette: {
            ...state.commandPalette,
            open,
          }
        },
        async (dispatch) => {
          if(open) {
            await nextTick();
            document.querySelector('#command-palette input').select();
            dispatch(HighlightMatches);
          }
        }
      ];
    };

    let SelectCommand = (state, index) => [
      {
        ...state,
        commandPalette: {
          ...state.commandPalette,
          selectedIndex: index,
        }
      },
      async () => {
        await nextTick();

        //scroll selected command into view
        let ul = document.querySelector('#command-palette ul');
        if (!ul) return;
        let li = ul.querySelector('li.selected');
        if (li.offsetTop < ul.scrollTop) {
          ul.scroll({ behavior: 'instant', top: li.offsetTop });
        } else if (ul.scrollTop + ul.clientHeight < li.offsetTop + li.clientHeight) {
          ul.scroll({ behavior: 'instant', top: li.offsetTop + li.clientHeight - ul.clientHeight });
        }
      }
    ];

    let SelectNextCommand = (state) => [SelectCommand, state.commandPalette.selectedIndex + 1];
    let SelectPrevCommand = (state) => [SelectCommand, state.commandPalette.selectedIndex - 1];

    let SetCommandQuery = (state, q) => ({
      ...state,
      commandPalette: {
        ...state.commandPalette,
        q: q.trim().toLowerCase(),
      },
    });

    let ExecuteSelectedCommand = state => state;
    let HighlightMatches = (state) => [
      state,
      async () => {
        await nextTick();

        let ranges = [];
        let q = state.commandPalette.q;
        document.querySelectorAll('#command-palette a').forEach(el => {
          let text = el.firstChild;
          let match = latinize(text.textContent).toLowerCase();
          if(match.includes(q)) {
            let start = match.indexOf(q);
            let end = start + q.length;
            let range = new Range();
            range.setStart(text, start);
            range.setEnd(text, end);
            ranges.push(range);
          }
        });
        let hl = new Highlight(...ranges);
        CSS.highlights.set('match', hl);
      }
    ];

    let MultipleActions = (state, actions) => [
      state,
      async (dispatch) => {
        for(let action of actions) {
          await nextTick();
          dispatch(...[].concat(action));
        }
      }
    ];

    let nextTick = async () => {
      await new Promise(resolve => requestAnimationFrame(resolve));
      await new Promise(resolve => requestAnimationFrame(resolve));
    };

    let onKey = (key, action, options) => (dispatch) => {
      let el = options?.target || window;
      let onKeyDown = (event) => {
        let opts = key.toLowerCase().split('+').reduce((opts, k) => {
          switch(k) {
            case 'ctrl':
            case 'shift':
            case 'alt':
              opts[k + 'Key'] = true;
              break;
            case 'cmd':
            case 'win':
            case 'super':
              opts.metaKey = true;
              break;
            default:
              opts.key = k;
          }
          return opts;
        }, {});
        if(event.key.toLowerCase() == opts.key.toLowerCase() && ['metaKey', 'ctrlKey', 'shiftKey', 'altKey'].every(f => Boolean(event[f]) == Boolean(opts[f]))) {
          event.preventDefault();
          dispatch(action);
        }
      };
      el.addEventListener('keydown', onKeyDown);
      return () => el.removeEventListener('keydown', onKeyDown);
    };

    let LoadSettings = (state) => [
      state,
      async (dispatch) => {
        let settings = {};
        let cursor = await state.db.transaction('settings').store.openCursor();
        while (cursor) {
          settings[cursor.key] = cursor.value;
          cursor = await cursor.continue();
        }
        dispatch(ApplySettings, settings);
      }
    ];
    let ApplySettings = (state, settings) => [
      { ...state, settings: { ...state.settings, ...settings } },
      () => {
        for (let [key, value] of Object.entries(settings)) {
          document.documentElement.dataset[key] = (value ?? '');
        }
      }
    ];
    let SaveSettings = (state, settings) => [
      state,
      async (dispatch) => {
        dispatch(ApplySettings, settings);

        let tx = state.db.transaction('settings', 'readwrite');
        await Promise.all([
          ...Object.entries(settings).map(([key, value]) => {
            document.documentElement.dataset[key] = (value || '');
            return tx.store.put(value, key);
          }),
          tx.done,
        ]);
      }
    ];

    let LoadRecentBooksDone = (state, { files }) => ({ ...state, files });
    let LoadRecentBooks = (state) => [
      state,
      async (dispatch) => {
        let files = await state.db.getAll('files');
        files.sort((a, z) => a.name.localeCompare(z.name, 'vi-VN', { sensitivity: 'accent' }));
        dispatch(LoadRecentBooksDone, { files });
      }
    ];

    let LoadProgressDone = (state, { progress }) => ({ ...state, progress });
    let LoadProgress = (state) => [state, async (dispatch) => {
      let progress = {};
      let cursor = await state.db.transaction('progress').store.openCursor();
      while (cursor) {
        progress[cursor.key] = cursor.value;
        cursor = await cursor.continue();
      }
      dispatch(LoadProgressDone, { progress });
    }];

    let LoadRecentBook = (state) => [
      state,
      (dispatch) => {
        let bookId = state.router.get('book');
        let chapterId = state.router.get('chapter');
        if (bookId) {
          dispatch(OpenBook, { bookId, chapterId })
        }
      }
    ];

    let OpenBookDone = (state, { book, chapter }) => [
      { ...state, book, chapter },
      (dispatch) => {
        if (state.book?.id == book.id)
          state.router.replace({ book: book.id, chapter: chapter.id });
        else
          state.router.push({ book: book.id, chapter: chapter.id });

        document.title = [...new Set([book.name, chapter.title])].join(' | ');

        requestAnimationFrame(() => {
          scroll(0, 0);

          //scroll bookmark into view
          let bookmark = document.querySelector('nav .active');
          let nav = document.querySelector('nav');
          let bookmarkRect = bookmark.getBoundingClientRect();
          let isOutOfView = bookmarkRect.top < 0 || nav.clientHeight < bookmarkRect.bottom;
          if (isOutOfView) bookmark.scrollIntoView({ block: 'center' });
        });
      }
    ];
    let OpenBook = (state, { bookId, chapterId, migrate = true, retry = true }) => [
      state,
      async (dispatch) => {
        if (!bookId) {
          console.info('Failed to load file:', { bookId, chapterId });
          return;
        }

        let [book, chapter] = await Promise.all([
          state.db.get('books', bookId),
          state.db.get('chapters', bookId + '/' + chapterId),
        ]);
        if (!book) {
          console.info('Book not found:', { book, chapter });
          if (migrate) dispatch(RefreshBook, { bookId, onSuccess: [OpenBook, { bookId, chapterId, migrate: false, retry }] });
          return
        }
        if (!chapter) {
          console.info('Chapter not found:', { bookId, chapterId });
          if (retry) {
            chapterId = book.chapters[0].id;
            dispatch(OpenBook, { bookId, chapterId, retry: false });
          }
          return;
        }

        let chapters = [...book.chapters];
        let chapterIndex = chapters.findIndex(c => c.id == chapter.id);
        if (chapterIndex < 0) chapterIndex = 0;
        chapters[chapterIndex] = chapter;

        dispatch(LoadNames, { bookId: book.id });
        dispatch(OpenBookDone, { book, chapter });
        dispatch(ToggleCommandPalette, { open: false });
        clearTimeout(window.saveProgressTimer);
        window.saveProgressTimer = setTimeout(() => {
          dispatch(SaveProgress, { book, chapter });
        }, 10000);
      }
    ];

    let ToggleNamesEditor = (state, { open }) => ({ ...state, namesEditor: { ...state.namesEditor, open } });
    let SetNames = (state, names) => ({ ...state, namesEditor: { ...state.namesEditor, names } });
    let SaveNames = (state, { bookId, names }) => [state, async (dispatch) => {
      await state.db.put('names', names, bookId);
    }];
    let LoadNames = (state, { bookId }) => [state, async (dispatch) => {
      let names = await state.db.get('names', bookId);
      dispatch(SetNames, names);
      dispatch(HighlightNames);
    }];
    memoize(function correctNames(content, names) {
      if(!names) return content;
      names = names.split('\n');
      // add short name automatically
      for(let name of names) {
        if(name.match(/->|â†’/)) continue;
        name = name.split(/\s/);
        if(name.length == 3 || name.length == 4) names.push(name.at(-2) + ' ' + name.at(-1));
      }
      for(let name of names) {
        name = name.trim();
        if (!name) continue;
        let [from, to] = name.split(/->|â†’/).map(n => n?.trim());
        if(to != undefined) {
          to = useCase(from, to);
        } else {
          from = name;
          to = titleCase(name);
        }
        if(from) {
          let fromRegex = new RegExp(`(?<=^|[^\\p{L}])${from}(?=[^\\p{L}]|$)`, 'gui');
          content = content.replaceAll(fromRegex, to);
        }
      }
      return content;
    });
    let HighlightNames = (state) => [state, async () => {
      await nextTick();

      CSS.highlights.clear();

      // names from editor
      let knowNames = [];
      if(state.namesEditor.names) {
        let names = (state.namesEditor.names || '').split('\n');
        // add short name automatically
        for(let name of names) {
          if(name.match(/->|â†’/)) continue;
          name = name.split(/\s/);
          if(name.length == 3 || name.length == 4) names.push(name.at(-2) + ' ' + name.at(-1));
        }
        for(let name of names) {
          name = name.trim();
          if (!name) continue;
          let [from, to] = name.split(/->|â†’/).map(n => n?.trim());
          if(to == undefined) {
            from = name;
            to = titleCase(name);
          }
          if(to && getCase(to) != 'lower') {
            knowNames.push(to);
          }
        }
      }

      // collect names
      let nameRegex = buildRegex([
        /{NameBegin}{Word}(\s{Word}){1,3}/,
        /{wb}a {Word}(?!{Word})/,
        /{NameBegin}{Word} (thÃºc|di|ca( ca)?|tá»·( tá»·)?|tá»•ng|lang|nÃ´|bÃ¡ bÃ¡|bÃ¡ phá»¥|bÃ¡ máº«u|Ä‘áº¡i tá»·|Ä‘áº¡i ca){wb}/,
        /(tiá»ƒu|lÃ£o) {Word}(?!{wb}{Word})/,
        knowNames.join('|'),
      ], {
        'wb': /$|(?<=[^\p{L}])|(?=[^\p{L}])/,
        'Upper': /\p{Lu}/,
        'Lower': /\p{Ll}/,
        'Word': /{wb}{Upper}{Lower}*{wb}/,
        'NameBegin': /(?<!^|[.:"'!?()[\]] ?|{Word} )/,
      }, 'gu');
      let names = new Set();
      document.querySelectorAll('article p, nav a').forEach(el => {
        el.childNodes.forEach(el => {
          if (el.nodeType != Node.TEXT_NODE) return;

          for(let match of el.textContent.matchAll(nameRegex)) {
            let name = match[0];
            names.add(name);
            name = name.split(/\s/);
            if(name.length == 3 || name.length == 4) names.add(name.at(-2) + ' ' + name.at(-1));
          }
        });
      });
      console.log({names})

      // create ranges;
      nameRegex = buildRegex([
        '{wb}(' + [...names].join('|') + '){wb}',
      ], {
        'wb': /^|$|(?<=[^\p{L}])|(?=[^\p{L}])/,
      }, 'gui');
      console.log('nameRegex:', nameRegex);
      let ranges = {};
      document.querySelectorAll('article p, nav a').forEach(el => {
        el.childNodes.forEach(el => {
          if (el.nodeType != Node.TEXT_NODE) return;

          for(let match of el.textContent.matchAll(nameRegex)) {
            let range = new Range();
            range.setStart(el, match.index);
            range.setEnd(el, match.index + match[0].length);
            let nameId = match[0].toLowerCase();
            if(!ranges[nameId]) ranges[nameId] = [];
            ranges[nameId].push(range);
          }
        });
      });

      // merge sub ranges
      let nameIds = Object.keys(ranges).sort((a, z) => z.length - a.length);
      console.debug(Object.keys(ranges));
      for(let nameId in ranges) {
        let fullNameId = nameIds.find(id => id.endsWith(' ' + nameId));
        if(fullNameId) {
          ranges[fullNameId].push(...ranges[nameId]);
          delete ranges[nameId];
        }
      }
      console.debug(Object.keys(ranges));
      console.debug((ranges));

      for(let nameId in ranges) {
        let color = stc(nameId);
        let styleId = slug(nameId);
        CSS.highlights.set(styleId, new Highlight(...ranges[nameId]));
        let styleEl = document.head.querySelector(`style[name="hl-${styleId}"]`);
        if(!styleEl) {
          styleEl = document.createElement('style');
          styleEl.setAttribute('name', `hl-${styleId}`);
          styleEl.textContent = `::highlight(${styleId}) { text-decoration: underline 5px solid ${color} !important; text-underline-offset: 6px; }`;
          document.head.appendChild(styleEl);
        }
      }
    }];

    let OpenNextChapter = (state, indexDelta = 1) => [
      state,
      (dispatch) => {
        let chapterIndex = state.book.chapters.findIndex(c => c.id == state.chapter.id);
        let nextChapter = state.book.chapters[chapterIndex + indexDelta];
        if (nextChapter) {
          dispatch(OpenBook, { bookId: state.book.id, chapterId: nextChapter.id });
        }
      }
    ];

    let SaveProgressDone = (state, { book, progress }) => ({ ...state, progress: { ...state.progress, [book.id]: progress } });
    let SaveProgress = (state, { book, chapter }) => {
      return [
        state,
        async (dispatch) => {
          let progress = (await state.db.get('progress', book.id) || {});
          progress.chapterId = chapter.id;
          progress.chapterIndex = book.chapters.findIndex(c => c.id == chapter.id) + (book.chapters[0].id ? 1 : 0);
          progress.chapterCount = (book.chapters[0].id ? book.chapters.length : book.chapters.length - 1);
          progress.updatedAt = new Date().toISOString();
          await state.db.put('progress', progress, book.id);
          dispatch(SaveProgressDone, { book, progress });
        }
      ];
    };

    let InitDropzone = (state) => [
      state,
      (dispatch) => {
        addEventListener('dragenter', event => { event.preventDefault(); });
        addEventListener('dragover', event => { event.preventDefault(); });
        addEventListener('drop', event => {
          event.preventDefault();
          let files = [...event.dataTransfer.files].filter(file => file.type == 'text/plain');
          dispatch(StoreFiles, { files });
        });
      }
    ];

    let StoreFilesDone = (state, { files }) => [
      state,
      async (dispatch) => {
        //refresh recent books in state
        dispatch(LoadRecentBooks);

        let filesOpenInNewTab = files;
        let fileOpenInCurrentTab = null;
        if(state.book) {
          //if this book is already open, open other files in new tabs
          fileOpenInCurrentTab = files.find(file => (Book(file).id == state.book.id));
          filesOpenInNewTab = files.filter(file => (file != fileOpenInCurrentTab));
        } else {
          //if no book is open, open the first file in current tab, other files in new tabs
          [fileOpenInCurrentTab, ...filesOpenInNewTab] = files;
        }

        if(fileOpenInCurrentTab) {
          let book = Book(fileOpenInCurrentTab);
          let chapterId = (await state.db.get('progress', book.id))?.chapterId;
          state.router.push({ book: book.id, chapterId });
          dispatch(OpenBook, { bookId: book.id, chapterId });
        }
        for(let { file } of filesOpenInNewTab) {
          let book = Book(file);
          let chapterId = (await state.db.get('progress', book.id))?.chapterId;
          window.open(`#book=${book.id}&chapter=${chapterId}`, '_blank');
        }
      }
    ];
    let StoreFiles = (state, { files: localFiles, fileContents }) => [
      state,
      async (dispatch) =>  {
        let readFile = (localFile) => new Promise(resolve => {
          let reader = new FileReader();
          reader.addEventListener('load', event => {
            let file = {
              name: localFile.name,
              size: localFile.size,
            };
            let fileContent = event.target.result;
            resolve({ file, fileContent });
          });
          reader.readAsText(localFile);
        });

        let files = [];
        for (let localFile of localFiles) {
          files.push(await readFile(localFile));
        }

        dispatch(StoreBooks, { files, onSuccess: [StoreFilesDone, { files }] });
        /**
        for (let i = 0; i < localFiles.length; i++) {
          let reader = new FileReader();
          reader.addEventListener('load', async event => {
            fileContents[i] = event.target.result;
            files[i] = {
              name: localFiles[i].name,
              size: localFiles[i].size,
            };

            let book = Book(files[i]);
            let existingFile = await state.db.get('files', book.id);
            if (existingFile?.size != files[i].size) {
              book = Book(files[i], fileContents[i]);
              dispatch(SaveProgress, { book, chapter: book.chapters[0] });
              updated[i] = true;
            }

            let tx = state.db.transaction(['files', 'fileContents'], 'readwrite');
            await Promise.all([
              tx.objectStore('files').put(files[i], book.id),
              tx.objectStore('fileContents').put(fileContents[i], book.id),
              tx.done,
            ]);

            dispatch(StoreBook, { bookId: book.id });
            storedCount++;

            if (storedCount == localFiles.length) {

            }
          });
          reader.readAsText(localFiles[i]);
        }
        /**/
      },
    ];

    let StoreBooks = (state, { files, onSuccess }) => [
      state,
      async (dispatch) => {
        let chapterKeys = await state.db.getAllKeys('chapters');

        let tx = state.db.transaction(['files', 'fileContents', 'books', 'chapters'], 'readwrite');
        await Promise.all([
          ...files.flatMap(({ file, fileContent }) => {
            console.log('new Book');
            let book = Book(file, fileContent);
            return [
              tx.objectStore('files').put(file, book.id),
              tx.objectStore('fileContents').put(fileContent, book.id),
              tx.objectStore('books').put(book.toJSON(), book.id),
              ...chapterKeys.filter(k => k.startsWith(book.id + '/')).map(k => tx.objectStore('chapters').delete(k)),
              ...book.chapters.map(c => tx.objectStore('chapters').put(c.toJSON(), book.id + '/' + c.id)),
            ];
          }),
          tx.done,
        ]);

        if (onSuccess) dispatch(...onSuccess);
      }
    ];

    let RefreshBook = (state, { bookId, onSuccess }) => [
      state,
      async (dispatch) => {
        if (!bookId) {
          console.info('Failed to load file:', { bookId, chapterId });
          return;
        }

        let [file, fileContent] = await Promise.all([
          state.db.get('files', bookId),
          state.db.get('fileContents', bookId),
        ]);
        if (!file || !fileContent) {
          console.info('File not found:', { bookId, file, fileContent });
          return;
        }

        if (!onSuccess) onSuccess = [OpenBook, { bookId, chapterId: state.chapter.id }];

        dispatch(StoreBooks, {
          files: [{ file, fileContent }],
          onSuccess,
        });
      }
    ];

    let DeleteBookDone = (state, { bookId }) => ({ ...state, files: state.files.filter(file => Book(file).id != bookId) });
    let DeleteBook = (state, { bookId }) => [
      state,
      async (dispatch) => {
        let chapterKeys = (await state.db.getAllKeys('chapters')).filter(k => k.startsWith(bookId + '/'));

        let tx = state.db.transaction(['files', 'fileContents', 'books', 'chapters'], 'readwrite');
        await Promise.all([
          tx.objectStore('files').delete(bookId),
          tx.objectStore('fileContents').delete(bookId),
          tx.objectStore('books').delete(bookId),
          ...chapterKeys.map(k => tx.objectStore('chapters').delete(k)),
          tx.done,
        ]);

        dispatch(DeleteBookDone, { bookId });
      }
    ];

    let ShowRecentBooks = (state) => {
      if (!state.book) return state;
      return [
        { ...state, book: null, chapter: null },
        (dispatch) => {
          clearTimeout(window.saveProgressTimer);
          state.router.push({});
          document.title = 'Text Reader';
          requestAnimationFrame(() => {
            scroll(0, 0);
          });
          dispatch(ToggleCommandPalette, { open: false });
        }
      ];
    };

    let sizeFormatter = new Intl.NumberFormat(undefined, { notation: 'compact', style: 'unit', unit: 'byte', unitDisplay: 'narrow' });
    let formatSize = sizeFormatter.format.bind(sizeFormatter);

    let dateFormatter = new Intl.RelativeTimeFormat();
    let formatDate = (iso) => {
      if(!iso) return;
      let diff = (Date.now () - new Date(iso)) / 1000;
      for (let [unit, seconds] of Object.entries({
        months: 30 * 24 * 60 * 60,
        days: 24 * 60 * 60,
        hours: 60 * 60,
        minutes: 60,
        seconds: 0,
      })) {
        if (diff >= seconds) return dateFormatter.format(-Math.round(diff / (seconds || 1)), unit);
      }
    };

    app({
      init: [
        {
          router: new HashRouter(),
          db: null,
          files: [],
          book: null,
          chapter: null,
          progress: {},
          settings: {
            sort: {
              field: 'updatedAt',
              direction: 'desc'
            }
          },
          commandPalette: {
            open: false,
            q: '',
            selectedIndex: 0,
          },
          namesEditor: {
            open: false,
            names: '',
            form: {
              names: '',
            },
          },
        },
        (dispatch) => {
          dispatch(InitRouter);
          dispatch(InitTheme);
          dispatch(InitDb);
          dispatch(InitDropzone);
        }
      ],
      dispatch: (dispatch) => {
        return (action, payload) => {
          if (!action) return;

          if (typeof action == 'function' && action.name.match(/^[A-Z]/)) {
            let log = [action.name];
            if (payload !== undefined) log.push(payload);
            console.warn(...log);
          }

          dispatch(action, payload);
        };
      },
      subscriptions: (state) => [
        [InitKeyboardNavigator],
        [InitCommandPalette],
      ],
      node: document.body,
      view: ({ router, files, book, chapter, progress, settings, commandPalette, namesEditor }) => {
        let fixNames = text => correctNames(text, namesEditor.names);
        let cachedCommands = window.cachedCommands = (window.cachedCommands || new Map());
        let commands = [], selectedCommand, commandKey;
        if(!book) {
          commands = simpleCache({
            key: 'commands/books',
            fallbackValue: [],
            getHash() { return files.length; },
            getValue() {
              return files.map((file, index) => {
                let book = Book(file);
                let { chapterId } = (progress[book.id] || {});
                return {
                  label: book.name,
                  action: OpenBook,
                  payload: { bookId: book.id, chapterId },
                  term: latinize(book.name).toLowerCase(),
                };
              });
            },
          });
        } else {
          commands = simpleCache({
            key: 'commands/books/' + book.id,
            fallbackValue: [],
            getHash() {
              let file = files.find(f => Book(f).id == book.id);
              return file.size;
            },
            getValue() {
              return book.chapters.map(chapter => ({
                label: fixNames(chapter.title),
                action: OpenBook,
                payload: { bookId: book.id, chapterId: chapter.id },
                term: latinize(chapter.title).toLowerCase(),
              }));
            },
          });
        }
        commands = commands.filter(cmd => cmd.term.includes(commandPalette.q)) ?? [];
        selectedCommand = commands[(commandPalette.selectedIndex + commands.length) % commands.length];
        return (
          h('body', {}, [
            h('nav', {}, [
              (book?.chapters?.length > 0) && (
                h('ol', { start: 0 }, [
                  ...book.chapters.map(c => (
                    h('li', { class: { active: c.id == chapter.id } }, [
                      h('a', {
                        href: router.route({ book: book.id, chapter: c.id }),
                        onclick: (_, event) => {
                          event.preventDefault();
                          return [OpenBook, { bookId: book.id, chapterId: c.id }];
                        },
                        title: fixNames(c.title),
                      }, [
                        text(fixNames(c.title))
                      ])
                    ])
                  ))
                ])
              )
            ]),
            !book && (
              h('div', { class: 'table' }, [
                h('a', {
                  class: 'th text-left',
                  'data-sort': settings.sort.field == 'name' && settings.sort.direction,
                  href: '#',
                  onclick: (_, event) => {
                    event.preventDefault();
                    let field = 'name', direction = 'asc';
                    if ((settings.sort.field == field) && (settings.sort.direction == direction)) direction = ['asc', 'desc'].find(d => d != direction);
                    return [SaveSettings, { sort: { field, direction } }];
                  }
                }, h('span', {}, text('File'))),
                h('a', {
                  class: 'th text-right',
                  'data-sort': settings.sort.field == 'size' && settings.sort.direction,
                  href: '#',
                  onclick: (_, event) => {
                    event.preventDefault();
                    let field = 'size', direction = 'asc';
                    if ((settings.sort.field == field) && (settings.sort.direction == direction)) direction = ['asc', 'desc'].find(d => d != direction);
                    return [SaveSettings, { sort: { field, direction } }];
                  }
                }, h('span', {}, text('Size'))),
                h('a', {
                  class: 'th text-right',
                  'data-sort': settings.sort.field == 'chapterCount' && settings.sort.direction,
                  href: '#',
                  onclick: (_, event) => {
                    event.preventDefault();
                    let field = 'chapterCount', direction = 'asc';
                    if ((settings.sort.field == field) && (settings.sort.direction == direction)) direction = ['asc', 'desc'].find(d => d != direction);
                    return [SaveSettings, { sort: { field, direction } }];
                  }
                }, h('span', {}, text('Chapters'))),
                h('a', {
                  class: 'th text-right',
                  'data-sort': settings.sort.field == 'updatedAt' && settings.sort.direction,
                  href: '#',
                  onclick: (_, event) => {
                    event.preventDefault();
                    let field = 'updatedAt', direction = 'desc';
                    if ((settings.sort.field == field) && (settings.sort.direction == direction)) direction = ['asc', 'desc'].find(d => d != direction);
                    return [SaveSettings, { sort: { field, direction } }];
                  }
                }, h('span', {}, text('Date'))),
                h('span', { class: 'th' }, h('span', {})),
                ...files.sort((a, z) => {
                  let { field, direction } = settings.sort;
                  let A = Book(a), Z = Book(z);
                  let result;
                  if (field == 'name') {
                    result = A.name.localeCompare(Z.name, 'vi-VN', { sensitivity: 'accent' });
                  } else if (field == 'size') {
                    result = a[field] - z[field];
                  } else if (field == 'updatedAt') {
                    a = new Date(progress[A.id]?.[field] || 0);
                    z = new Date(progress[Z.id]?.[field] || 0);
                    result = a - z;
                  } else if (field == 'chapterCount') {
                    result = (progress[A.id]?.[field] || 1) - (progress[Z.id]?.[field] || 1);
                  }
                  if ((direction == 'desc') && (result != 0)) result = -result;
                  return result;
                }).flatMap(file => {
                  let book = Book(file);
                  let { chapterId, chapterIndex, chapterCount, updatedAt } = (progress[book.id] || {});
                  return [
                    h('div', { class: 'td' }, [
                      h('a', {
                        class: 'name',
                        href: router.route({ book: book.id, chapter: chapterId }),
                        onclick: (_, event) => {
                          event.preventDefault();
                          return [OpenBook, { bookId: book.id, chapterId }];
                        }
                      }, [
                        text(book.name)
                      ]),
                      book.description && (
                        h('small', { class: 'desc' }, text(book.description))
                      )
                    ]),
                    h('div', { class: 'td text-right' }, [
                      h('small', {}, text(formatSize(file.size)))
                    ]),
                    h('div', { class: 'td text-right' }, [
                      h('small', {}, text(!chapterCount ? '-' : `${chapterIndex}/${chapterCount}`))
                    ]),
                    h('div', { class: 'td text-right' }, [
                      h('small', {}, text(formatDate(updatedAt) || '-'))
                    ]),
                    h('div', { class: 'td' }, [
                      h('a', { class: 'delete', onclick: [DeleteBook, { bookId: book.id }] }, [
                        h('small', {}, text('delete'))
                      ])
                    ])
                  ]
                })
              ])
            ),
            chapter && (
              h('main', {}, [
                h('article', {}, [
                  ...fixNames(chapter.content).split(/\n|<\/?\w+>/gi).map(line => {
                    if (/^[-]+$/.test(line)) return h('hr', {});
                    if (/^[^\p{L}\p{N}"]+$/u.test(line)) return h('p', { class: 'text-center indent-none' }, text(line));
                    let content = [], m;
                    while ((m = /https?:\/\/\S+/.exec(line))) {
                      if (m.index > 0) content.push(text(line.slice(0, m.index)));
                      content.push(h('a', { href: m[0], target: '_blank' }, [text(m[0])]));
                      line = line.slice(m.index + m[0].length);
                    }
                    if (line) content.push(text(line));
                    // if (/^"/.test(line)) return h('p', {}, h('em', {}, text(line)));
                    return h('p', {}, content);
                  })
                ])
              ])
            ),
            h('aside', { class: 'settings' }, [
              chapter && (
                h('div', {}, [
                  h('a', {
                    class: 'close',
                    href: router.route({}),
                    onclick: (_, event) => {
                      event.preventDefault();
                      return [ShowRecentBooks];
                    },
                    title: 'Back to bookshelf',
                  })
                ])
              ),
              h('div', { class: 'colors' }, ['white', 'sepia', 'gray', 'night', 'rose-pine', 'rose-pine-moon', 'rose-pine-dawn'].map(color => (
                h('button', {
                  class: [color, { 'checked:light': settings['color:light'] == color, 'checked:dark': settings['color:dark'] == color }],
                  onclick: () => [SaveSettings, { [`color:${getColorScheme()}`]: color }],
                  title: `Theme: ${color}`,
                })
              ))),
              h('div', { class: 'paper-size' }, ['sm', 'md', 'lg', 'xl'].map(size => (
                h('button', {
                  class: ['size', size, { selected: settings.paperSize == size }],
                  onclick: [SaveSettings, { paperSize: size }],
                  title: `Page size: ${size}`,
                }, text(size))
              ))),
              chapter && (
                h('div', {}, [
                  h('button', {
                    class: 'refresh',
                    onclick: [RefreshBook, { bookId: book.id, chapterId: chapter.id }],
                    title: 'Refresh book',
                  }),
                  h('button', {
                    class: 'zen',
                    onclick: [SaveSettings, { zen: !settings.zen }],
                    title: 'Toggle Zen Mode',
                  }),
                  h('button', {
                    class: 'names-editor',
                    onclick: [ToggleNamesEditor, { open: true }],
                    title: 'Edit names',
                  }),
                ])
              )
            ]),
            h('dialog', { id: 'command-palette', open: commandPalette.open }, [
              h('form', {
                onsubmit: (_, event) => {
                  event.preventDefault();
                  return [MultipleActions, [
                    [selectedCommand.action, selectedCommand.payload],
                    [ToggleCommandPalette, { open: false }],
                  ]];
                }
              }, [
                h('input', {
                  oninput: (_, event) => [MultipleActions, [
                    [SetCommandQuery, event.target.value],
                    [SelectCommand, 0],
                    [HighlightMatches],
                  ]],
                }),
                h('input', { type: 'submit', hidden: true }),
              ]),
              commands.length > 0 && h('ul', {}, [
                ...commands.map((command, index) => (
                  h('li', {
                    class: { selected: command == selectedCommand }
                  },
                    h('a', {
                      href: router.route({ book: command.payload.bookId, chapter: command.payload.chapterId }),
                      onclick: (_, event) => {
                        event.preventDefault();
                        return [MultipleActions, [
                          [SelectCommand, index],
                          [command.action, command.payload],
                          [ToggleCommandPalette, { open: false }],
                        ]]
                      },
                      title: command.label,
                    },[
                      text(command.label),
                    ])
                  )
                ))
              ])
            ]),
            h('dialog', { id: 'names-editor', open: namesEditor.open }, [
              h('form', {
                onsubmit: (_, event) => {
                  event.preventDefault();
                  return [MultipleActions, [
                    [ToggleNamesEditor, { open: false }],
                    [SaveNames, { bookId: book.id, names: namesEditor.names }],
                    [HighlightNames],
                  ]];
                }
              }, [
                h('textarea', {
                  value: namesEditor.names,
                  oninput: (_, event) => [SetNames, event.target.value],
                  onkeydown: (_, event) => {
                    if (event.key == 'Escape') {
                      return [ToggleNamesEditor, { open: false }];
                    } else if (event.key == 'Enter' && event.metaKey) {
                      return [MultipleActions, [
                        [ToggleNamesEditor, { open: false }],
                        [SaveNames, { bookId: book.id, names: namesEditor.names }],
                        [HighlightNames],
                      ]];
                    }
                  },
                }),
                h('button', { type: 'submit' }, [text('Save')]),
              ])
            ])
          ])
        );
      }
    });

    function Book(file, fileContent, chapters) {
      let id, name, description;
      if (file?.name) {
        name = /(?<name>^[^(]*).*?\.txt/.exec(file.name.normalize()).groups.name.trim();
        description = /(?<description>\(.*)\.txt/.exec(file?.name.normalize())?.groups?.description?.trim();
        id = slug(name);
      }
      if (fileContent) {
        fileContent = normalizeFileContent(fileContent);
        // fileContent = titleizeHumanName(fileContent);
        chapters = extractChapters(name, fileContent, { name });
      }
      return {
        id,
        name,
        description,
        chapters,
        toJSON() {
          return {
            id,
            name,
            description,
            chapters: chapters.map(c => {
              c = c.toJSON();
              delete c.content;
              return c;
            }),
          }
        }
      };
    }

    function normalizeFileContent(text) {
      text = text.normalize();
      text = text.replace(/[\r\n]+/g, '\n');
      text = text.replace(/\t+/g, '\n');
      text = text.replace(/(?<=\S) {2,}(?=\p{Lu})/gu, '\n');
      text = text.replace(/(.+)/g, (s) => s.trim());
      text = text.replace(/^'([^']+)'$/gm, '"$1"');
      text = text.replace(/(\d)\s*(\.)\s*(\d)/gm, '$1$2$3');
      text = text.replace(/\s+([.,;:?!\]ã€‘)])/gm, '$1');
      text = text.replace(/([([ã€])\s+/gm, '$1');
      text = text.replace(/([:â€”]{2,})/gm, c => c.slice(0, 1));
      text = text.replace(/(:)[^\s\w]+\s*/gm, '$1 ');
      text = text.replace(/^\s*"\s+|\s+"\s*$/gm, '"');
      //"QQ Group 712797052"
      text = text.replace(/\s?"?QQ Group \d+"?/gu, '');
      //tÃ¬m sÃ¡ch a "Cuá»™c Ä‘á»i nÃ y khÃ´ng phá»¥ diÃªn Ä‘uÃ´i tÃ¬nh" cÃ¡ nhÃ¢n cáº£i biÃªn
      text = text.replaceAll('  tÃ¬m sÃ¡ch a "Cuá»™c Ä‘á»i nÃ y khÃ´ng phá»¥ diÃªn Ä‘uÃ´i tÃ¬nh" cÃ¡ nhÃ¢n cáº£i biÃªn', '');
      text = text.replace(/\b(?<protocol>https?:)(?:\/\/)? (?<path>(?:\w+)(?:\. \w+)+(?:\/(?:(?:\. )?[\w\/])+)?)/gm, (...args) => {
        let { protocol, path } = args.pop();
        path = path.replace(/\s/g, '');
        if (protocol) return protocol + '//' + path;
        return path;
      });
      text = text.replaceAll('cha máº¹ vá»£', 'máº¹ vá»£');
      return text;
    }

    let printed = true;
    function Chapter(_, { chapters, filename, text }) {
      return {
        _,
        merged: 1,
        get title() {
          let originalTitle = _.title || _.titleShort;
          let title, titleBook, titleChap, phienNgoai, halfPre, halfPost;
          titleBook = this.book;
          if (/phiÃªn ngoáº¡i/iu.test(_.text) && !/phiÃªn ngoáº¡i/iu.test(originalTitle)) phienNgoai = 'PhiÃªn ngoáº¡i';
          if (this.chapter != null) titleChap = this.chapType + ' ' + this.chapter;
          if (this.half && !originalTitle?.includes('(' + this.half + ')')) {
            if (_.halfType) halfPre = this.half + ':';
            else halfPost = '(' + this.half + ')';
          }
          title = [titleBook, phienNgoai, titleChap].filter(Boolean).join(' ');
          title = [title, (originalTitle || '').replace(/./, c => c.toUpperCase())].filter(Boolean).join(': ');
          title = [halfPre, title, halfPost].filter(Boolean).join(' ');
          if (!title) title = this.chapType + ' ' + (this.i + 1);
          if (!printed) {
            printed = true;
            if (title.includes('26')) {
              console.warn('diz', this);
            }
          }
          return title;
        },
        get i() {
          return chapters.indexOf(this);
        },
        get startIndex() {
          // return text.lastIndexOf('\n', _.index);
          return _.index;
        },
        get endIndex() {
          if (this.i == chapters.length-1) return text.length;
          return chapters[this.i + 1].startIndex;
        },
        get id() {
          return slug(this.title) + '-' + this.i;
        },
        get content() {
          return text.slice(this.startIndex, this.endIndex).trim();
        },
        get chapter() {
          return _.chapNum || _.chapText;
        },
        get chapNo() {
          if (this.chapter) return Number(this.chapter)
        },
        get chapType() {
          return _.chapType || 'ChÆ°Æ¡ng'
        },
        get length() {
          return this.endIndex - this.startIndex;
        },
        get half() {
          return [_.halfType, _.halfNum || _.halfText].filter(Boolean).join(' ');
        },
        get halfNo() {
          if (_.halfNum) return Number(_.halfNum);
        },
        get halfType() {
          return _.halfType;
        },
        get bookType() {
          if (_.bookType) return _.bookType.toLowerCase().replace(/^./, c => c.toUpperCase());
        },
        get bookNo() {
          if (_.bookNum) return Number(_.bookNum);
          if (_.bookText) return Number(_.bookText);
        },
        get book() {
          if(_.bookNum || _.bookText) {
            return [_.bookType || 'Quyá»ƒn', Number(_.bookNum) || Number(_.bookText)].filter(Boolean).join(' ');
          }
        },
        toJSON() {
          return {
            id: this.id,
            title: this.title,
            content: this.content,
          }
        }
      };
    }

    function extractChapters(filename, text, { name }) {
      let NUMERIC = '(\\d{1,4}(\\.\\d{1,2})*)';
      let NUMERIC_DECIMAL = '(\\d{1,4}(\\.\\d{1,2})+)';
      let NUMERIC_WORDS = '(mÆ°á»i( (má»™t|hai|ba|bá»‘n|lÄƒm|sÃ¡u|báº£y|tÃ¡m|chÃ­n))?|(hai|ba|bá»‘n|nÄƒm|sÃ¡u|báº£y|tÃ¡m|chÃ­n) mÆ°Æ¡i( (má»‘t|hai|ba|bá»‘n|lÄƒm|sÃ¡u|báº£y|tÃ¡m|chÃ­n))?|má»™t|hai|ba|bá»‘n|nÄƒm|sÃ¡u|báº£y|tÃ¡m|chÃ­n)|(((tháº­p|bÃ¡ch|thiÃªn|váº¡n) )?(nháº¥t|nhá»‹|tam|tá»©|ngÅ©|lá»¥c|tháº¥t|bÃ¡t|cá»­u|tháº­p))+|[MDCLXVI]+';
      let patterns = [
        /*
        ã€xanh biáº¿c lá»¯ du tiÃªnã€‘ bá»™ 2 tá»± chÆ°Æ¡ng
        ã€xanh biáº¿c lá»¯ du tiÃªnã€‘ bá»™ 2 thá»© 01 chÆ°Æ¡ng
        Xanh Biáº¿c lá»¯ du tiÃªn bá»™ 2 thá»© 09 chÆ°Æ¡ng
        ã€xanh biáº¿c lá»¯ du tiÃªn bá»™ 2ã€‘ thá»© 10 chÆ°Æ¡ng ÄÃ´ng háº£i tiÃªn cÃ¡c (1)
        Xanh Biáº¿c lá»¯ du tiÃªn bá»™ 2 thá»© 13 chÆ°Æ¡ng Ná»¯ Äáº¿ dÃ¢m tÃ¢m
        ã€xanh biáº¿c lá»¯ du tiÃªnã€‘ ChÆ°Æ¡ng 8:
        ã€ChÆ°Æ¡ng 8: TÃ´ng mÃ´n dÃ¢m loáº¡n (nháº¥t)ã€‘
        ã€xanh biáº¿c lá»¯ du tiÃªnã€‘ ChÆ°Æ¡ng 6:
        ã€ChÆ°Æ¡ng 6: HoÃ ng thÃ nh long áº£nhã€‘
        Thá»© 02 chÆ°Æ¡ng: Hong Kong
        Thá»© 1 chÆ°Æ¡ng Ä‘áº¡i nghá»‹ch báº¥t Ä‘áº¡o Ã¡i Ä‘á»“, nhÆ°ng láº¡i hy vá»ng Ä‘em sÆ° tÃ´n dáº¡y dá»— vÃ¬ song tu chuyÃªn dá»¥ng áº¥u thÃª!
        Thá»© 10 chÆ°Æ¡ng, vÃµ diá»…m hÃ²a khÃ´ng rÃµ thÃ¢n pháº­n nam nhÃ¢n thÃ´ng Ä‘á»“ng cÃ¹ng vá»›i tráº§n san cÃ¹ng ca ca tráº§n vá»«a loáº¡n luÃ¢n Ä‘á»‹t bi chuyá»‡n xÆ°a
        ã€máº¹ thÃ nh gia bÃªn trong báº£o máº«u con dÃ¢uã€‘(15) hoÃ n
        Nhá»‹, thay Ä‘á»•i
        ã€báº¡n gÃ¡i Ä‘á»‡ Ä‘á»‡ã€‘3
        "Báº¡n gÃ¡i Ä‘á»‡ Ä‘á»‡" 11
        ThÆ°á»£ng (2)
        ChÃ­nh VÄƒn ChÆ°Æ¡ng 07: Chá»‰nh quÃ¢n
        Nháº¥t, lá»i dáº«n tÆ°á»Ÿng nÃ³i ngáº¯n gá»n, nhÆ°ng khÃ´ng biáº¿t tá»« Ä‘Ã¢u nÃ³i lÃªn.
        Thá»© 34 chÆ°Æ¡ng máº«u thÆ°á»£ng cÃ´ng lÆ°á»£c (3.11) An Náº·c tiáº¿n bá»‡nh viá»‡n
        â€” ChÆ°Æ¡ng 2: (dá»‹ch nÃ³ng thá»ƒ)â€”
        2020 nÄƒm thÃ¡ng 1 6 ngÃ y
        Háº¡ bá»™ â€” chá»‹ em yÃªu nhau (lá»¥c hi hÃ²a lá»¥c náº¿u)
        ã€máº¹ conã€‘(nhá»‹ -- yÃªu nÃ³i háº¿t)
        (nhá»‹ -- yÃªu nÃ³i háº¿t)
        ch. 1
        Há»“i 1: NgÃ¢y thÆ¡ diá»‡n máº¡o Khuynh ThÃ nh váº­n giao mui xe thá»‹ lÃ£o Ã”ng phá»§ áº¥u tá»­ tá»« huá»‡ thá»¥c hiá»n Hongkong
        Thá»© 41-48 chÆ°Æ¡ng
        */
        //ChÆ°Æ¡ng 23:
        //PhiÃªn ngoáº¡i ChÆ°Æ¡ng 18:
        '^(PhiÃªn Ngoáº¡i )?CHAP_TYPE CHAP_NUM:$',
        //ChÆ°Æ¡ng 1: TÃ¢n niÃªn Ä‘áº·c biá»‡t thiÃªn (thÆ°á»£ng)
        //PhiÃªn Ngoáº¡i ChÆ°Æ¡ng 8: Treo Ä‘áº§u dÃª bÃ¡n thá»‹t chÃ³
        //...Ä‘Ã£ ngá»§ say. ChÆ°Æ¡ng 59: máº¹ phÃ¡t hiá»‡n chÃ¢n tÆ°á»›ng
        //Há»“i 2: Â· pháº«n vÅ© ná»¯ khinh thÃ¢n dá»¥ Ä‘á»‹ch tÃ¹, nhu vÃº to thÃ¡t tá»­ loáº¡n tÃ¢m trÃ­
        '(^|(?<=\\W ))(PhiÃªn Ngoáº¡i )?CHAP_TYPE CHAP_NUM([^\\p{L}\\p{N}]+TITLE)?$',
        //NgÅ©
        //Hai mÆ°Æ¡i má»‘t
        '^CHAP_TEXT$',
        // (1)
        '^\\(CHAP_NUM\\)$',
        //8.1
        '^CHAP_NUM$',
        // (tá»©)
        // (mÆ°á»i má»™t)
        '^\\(CHAP_TEXT\\)$',
        //Thá»© 7 chÆ°Æ¡ng máº«u thÆ°á»£ng cÃ´ng lÆ°á»£c (1.7) tiá»ƒu ma ná»¯ phá»¥c vá»¥
        // '^Thá»© BOOK_NUM chÆ°Æ¡ng ' + name + ' \\(CHAP_NUM\\)([: ]TITLE)?',
        //Thá»© 31 chÆ°Æ¡ng
        //Táº­p thá»© nháº¥t thá»© 01 chÆ°Æ¡ng tháº¥t Ä‘á»a vÃ¡ch nÃºi Ä‘en
        '^(BOOK_TYPE( thá»©)? (BOOK_NUM|BOOK_TEXT) )?Thá»© CHAP_NUM CHAP_TYPE([: ]TITLE)?',
        //[thá»© 1 chÆ°Æ¡ng]
        '^\\[thá»© CHAP_NUM CHAP_TYPE\\]',
        //Báº£y nÄƒm vá»£ chá»“ng gáº§n ba nÄƒm cÃ¹ng hai cÃ¡i Ä‘Æ¡n nam Ä‘á»‡ tá»­ chuyá»‡n xÆ°a (5)
        '^' + name + ' \\(CHAP_NUM\\)',
        //2019-7-19 mÆ°á»i lÄƒm
        '^DATE CHAP_TEXT',
        //MÆ°á»i hai, ná»­a nÄƒm sau cuá»™c sá»‘ng váº«n Ä‘ang tiáº¿p tá»¥c. Phá»‘ xÃ¡ nhÆ° trÆ°á»›c thÃ¡i bÃ¬nh.
        '^CHAP_TEXT[,] TITLE$',
        //Quyá»ƒn thá»© hai ChÆ°Æ¡ng 11: Má»¹ máº«u cáº§u xin
        //Táº­p 6 ChÆ°Æ¡ng 110: NhÃ¢n thay má»›i trang
        '^BOOK_TYPE( thá»©)? (BOOK_NUM|BOOK_TEXT) CHAP_TYPE CHAP_NUM: TITLE',
        //Lá»i dáº«n
        '^(?<title>CHAP_TYPE (cuá»‘i|káº¿t)|tá»± chÆ°Æ¡ng|Lá»i dáº«n)$',
        //(ChÆ°Æ¡ng 20: hÃ¨n chÃ³ diá»…n phÆ°á»£ng (che giáº¥u thiÃªn 3)
        '^\\(CHAP_TYPE CHAP_NUM: TITLE',
        //PhiÃªn Ngoáº¡i hai mÆ°Æ¡i lÄƒm chÆ°Æ¡ng
        '^(PhiÃªn Ngoáº¡i )CHAP_TEXT CHAP_TYPE',
        //ã€ Ä‘á»a phá»¥ ã€‘ ChÆ°Æ¡ng 2:: Khuáº¥t nhá»¥c phu nhÃ¢n
        '^ã€NAMEã€‘ CHAP_TYPE CHAP_NUM: TITLE',
        //ã€xanh biáº¿c lá»¯ du tiÃªnã€‘ bá»™ 2 thá»© 08 chÆ°Æ¡ng
        '^ã€NAMEã€‘ bá»™ BOOK_NUM thá»© CHAP_NUM CHAP_TYPE',
        //Xanh biáº¿c lá»¯ du tiÃªn bá»™ 2 ChÆ°Æ¡ng 8: SÆ¡ ngá»™ bÃ­ch du
        '^NAME bá»™ BOOK_NUM CHAP_TYPE CHAP_NUM: TITLE',
        //ã€báº¡n gÃ¡i Ä‘á»‡ Ä‘á»‡ã€‘9
        '^ã€NAMEã€‘CHAP_NUM([: ]TITLE)?',
        //ã€cÃ¡c huynh Ä‘á»‡ loáº¡n luÃ¢n thá»‹nh yáº¿nã€‘(tam)
        //ã€khÃ´ng chá»‰ tÃ¬nh yÃªuã€‘(1)
        //ã€khÃ´ng chá»‰ tÃ¬nh yÃªuã€‘(18) hoÃ n
        '^ã€NAMEã€‘\\((CHAP_TEXT|CHAP_NUM)\\)( TITLE)?',
        //ã€cá»§a ta giang há»“ã€‘(thá»© 2 chÆ°Æ¡ng)
        '^ã€NAMEã€‘\\(thá»© CHAP_NUM CHAP_TYPE\\)',
        //ã€khÃ´ng chá»‰ tÃ¬nh yÃªuã€‘(phiÃªn ngoáº¡i) cáº£nh phá»‰ máº¹ con kÃ­ch tÃ¬nh thÆ°á»£ng kÃ­nh
        '^ã€NAMEã€‘(phiÃªn ngoáº¡i) TITLE',
        //ã€phiÃªn ngoáº¡i thiÃªn chi Diá»‡p Minh Hi tá»± báº¡chã€‘(1)
        'ã€(?=.*?phiÃªn ngoáº¡i)(?<title>.*?)ã€‘\\(CHAP_NUM\\)',
        //ã€khÃ´ng chá»‰ tÃ¬nh yÃªuã€‘(phiÃªn ngoáº¡i) cáº£nh phá»‰ máº¹ con kÃ­ch tÃ¬nh thÆ°á»£ng kÃ­nh
        '^ã€NAMEã€‘\\(phiÃªn ngoáº¡i\\) TITLE',
        //NgÆ°á»i nhÃ  quáº§n Ã¡o ChÆ°Æ¡ng 1: Máº¹ dá»‹ thÆ°á»ng
        '^NAME CHAP_TYPE CHAP_NUM: TITLE',
        //NÃ³n xanh máº·c ta mang (nháº¥t) kinh vi thiÃªn nhÃ¢n
        '^NAME \\(CHAP_TEXT\\) TITLE',
        //(báº£n cÅ©) dÃ¢m loáº¡n gia Ä‘Ã¬nh thá»© 01 chÆ°Æ¡ng: Sau khi tan lá»›p ba ba Ã¢u yáº¿m
        'NAME thá»© CHAP_NUM CHAP_TYPE: TITLE',
        //(16) A Kiá»‡n nÃ³i: NÃ ng... NÃ ng lÃ  ta... Muá»™i muá»™i
        '^\\(CHAP_NUM\\) TITLE',
        //..."Ã‚n, ta Ä‘á»u nghe ngÆ°Æ¡i!" (13)
        '(?<=\\W) \\(CHAP_NUM\\)$',
        //(14) nghiÃªm háº¡o táº¡i sofa phÃ­a trÃªn thÃ­ch khÃ´ng thá»ƒ tá»± thoÃ¡t ra Ä‘Æ°á»£c, nháº¥t tinh máº·c xong Ä‘á»“ ngá»§, sau Ä‘Ã³ tiáº¿p láº¥y Ä‘em nghiÃªm háº¡o Ã´m Ä‘áº¿n chÃ¢n cá»§a mÃ¬nh phÃ­a trÃªn, nháº¹ nhÃ ng Ã¢u yáº¿m.
        '\\(CHAP_NUM\\)',
        //"2" hÃ o mÃ´n bÃ­ máº­t
        '^"\\s*CHAP_NUM\\s*"( TITLE)?',
        //"13 chÆ°Æ¡ng káº¿t"
        '^"CHAP_NUM TITLE"$',
        //Táº­p thá»© hai thá»© 36 chÆ°Æ¡ng con tin uy hiáº¿p
        '^Táº­p thá»© BOOK_TEXT thá»© CHAP_NUM CHAP_TYPE TITLE$',
        //22)
        '^CHAP_NUM\\)$',
        //2,
        '^CHAP_NUM,$',
        //Tá»± máº«u má»™t ngÃ y (háº¡)
        '^(?<!.*CHAP_TYPE.*TITLE) \\(HALF_TEXT\\)$',
        //Thá»© 1002 chÆ°Æ¡ng lá»¯ má»™ng Ä‘áº¹p cáº£nh nhÃ£ nhÃ n bÃ¡ máº«u (nhá»‹)
        '^Thá»© CHAP_NUM CHAP_TYPE TITLE',
        //Äá»‡ nháº¥t bá»™ tá»© Ä‘áº¡i má»¹ ná»¯ chi Ä‘áº¹p nháº¥t thá»‹ trÆ°á»Ÿng dÆ°Æ¡ng ngÆ°ng bÄƒng (thÆ°á»£ng)
        '^Äá»‡ (BOOK_NUM|BOOK_TEXT) BOOK_TYPE TITLE \\(HALF_TEXT\\)',
        //Bá»™ 2 tá»© Ä‘áº¡i má»¹ ná»¯ chi kim bÃ i chá»§ trÃ¬ dÆ°Æ¡ng ninh lÃ m (háº¡)
        '^BOOK_TYPE BOOK_NUM TITLE \\(HALF_TEXT\\)',
        //(ChÆ°Æ¡ng 20: hÃ¨n chÃ³ diá»…n phÆ°á»£ng (che giáº¥u thiÃªn 2)
        '^\\(CHAP_TYPE CHAP_NUM: TITLE HALF_TEXT\\)',
        //Äá»‡ 1 chÆ°Æ¡ng: (Máº¹ Mamako)
        //Äá»‡ 8 chÆ°Æ¡ng, Ä‘áº©y ngÆ°á»£c pháº£n bá»‹ Ä‘á»‹t.
        '^(Äá»‡|thá»©) CHAP_NUM CHAP_TYPE[,:]? TITLE',
        //Quyá»ƒn thá»© hai thiáº¿t giÃ¡p phong vÃ¢n
        '^BOOK_TYPE( thá»©)? (BOOK_NUM|BOOK_TEXT)( BOOK_TITLE)?$',
        //Thá»© 4 cuá»‘n Ä‘áº¿ Ä‘Ã´ bi ca
        '^Thá»© BOOK_NUM BOOK_TYPE BOOK_TITLE',
        //1.1 nhÃ¢n váº­t chÃ­nh kÃªu mÅ©
        '^CHAP_NUM_DECIMAL TITLE$',
        //(4.25)G con máº¹ nÃ³ du há»c sinh
        '^\\(CHAP_NUM\\) ?TITLE$',
        //ChÆ°Æ¡ng mÆ°á»i:
        '^CHAP_TYPE CHAP_TEXT:$',
        //ChÆ°Æ¡ng ba mÆ°Æ¡i lÄƒm láº¡i rÃ¬nh coi
        '^CHAP_TYPE CHAP_TEXT TITLE$',
        //Ba mÆ°Æ¡i tÃ¡m chÆ°Æ¡ng Tuyáº¿t Nhi tÃ¢n hÃ´n
        '^CHAP_TEXT CHAP_TYPE TITLE$',
        //Bá»‘n mÆ°Æ¡i chÆ°Æ¡ng
        '^CHAP_TEXT CHAP_TYPE$',
        //(tam) máº¥y ngÃ y káº¿ tiáº¿p, máº¹ ngÆ°á»£c láº¡i khÃ´ng hÆ°á»›ng Ä‘áº¿n LÃ½ TÆ° oa trong nhÃ  cháº¡y, má»—i ngÃ y táº¡i trong nhÃ  náº¥u cÆ¡m mang Ä‘á»©a nhá», tÃ¢m tÃ¬nh thÆ°á»£ng cÅ©ng khÃ´ng tá»‡.
        '^\\(CHAP_TEXT\\)',
        //(cÃ²n tiáº¿p) mÆ°á»i ba (thÆ°á»£ng) Ä‘Ã£ xáº£y ra chuyá»‡n â€” ba chá»¯ nÃ y bÃ¬nh thÆ°á»ng lÃ  chá»‰ phÃ¡t sinh khÃ´ng tá»‘t sá»± tÃ¬nh, chuyá»‡n tá»‘t nhi cÅ©ng khÃ´ng cÃ³ kháº£ nÄƒng dÃ¹ng nÃ y ba tá»±, hÆ¡n ná»¯a cÃ³ thá»ƒ lá»›n cÃ³ thá»ƒ nhá», nhá» Ä‘áº¿n táº¡i ban thÆ°á»£ng nghá»‹ch ngá»£m gÃ¢y sá»± Ä‘Ã¹a giá»¡n báº¡n há»c gÃ¡i bá»‹ lÃ£o sÆ° Ä‘Ã£ biáº¿t, lá»›n Ä‘áº¿n hai quá»‘c gia phÃ¡t sinh chiáº¿n tranh, Ä‘á»u cÃ³ thá»ƒ kÃªu Ä‘Ã£ xáº£y ra chuyá»‡n.
        '^\\(cÃ²n tiáº¿p\\) CHAP_TEXT \\(HALF_TEXT\\)',
        //MÆ°á»i ba (háº¡) theo lá»›n máº­p gia trong nhÃ  Ä‘i ra ta liá»n hÆ°á»›ng Ä‘áº¿n gia Ä‘uá»•i, tháº­m chÃ­ sá»£ thá»i gian Ä‘uá»•i khÃ´ng ká»‹p Ä‘i nhanh cháº¡y, ká»³ tháº­t ta lÃ  khÃ´ng quÃ¡ nguyá»‡n Ã½ hÆ°á»›ng Ä‘áº¿n chá»— Ä‘Ã³ nghÄ©, ná»™i tÃ¢m tháº­m chÃ­ cÃ³ má»™t chÃºt khÃ¡ng cá»± cÃ¡i Ã½ nghÄ© nÃ y, nhÆ°ng náº¿u nhÆ° hiá»‡n thá»±c chÃ­nh lÃ  nhÆ° váº­y Ä‘Ã¢u.
        '^CHAP_TEXT \\(HALF_TEXT\\)',
        //(cÃ²n tiáº¿p) mÆ°á»i báº£y Ä‘Ã£ tráº£i qua nhiá»u nhÆ° váº­y ly ká»³ sá»± tÃ¬nh, ta cho ráº±ng chÃ­nh mÃ¬nh Ä‘Ã£ lÃ  ngÆ°á»i lá»›n, tÃ­nh lÃ  cÃ¹ng Ä‘áº¡i nhÃ¢n cÃ³ chÃºt chÃªnh lá»‡ch, cÅ©ng khÃ´ng cÃ³ kháº£ nÄƒng khÃ¡c biá»‡t quÃ¡ xa.
        '^\\(cÃ²n tiáº¿p\\) CHAP_TEXT',
        //(cÃ²n tiáº¿p)(mÆ°á»i má»™t) "Tiá»ƒu ChÃ­ tiá»ƒu LÃ´i rá»i giÆ°á»ng Äƒn cÆ¡m."
        '^\\(cÃ²n tiáº¿p\\)\\(CHAP_TEXT\\)',
        //MÆ°á»i bá»‘n "Tiá»ƒu ChÃ­ nhÆ° tháº¿ nÃ o cÃ²n khÃ´ng cÃ³ rá»i giÆ°á»ng, ngÆ°Æ¡i khÃ´ng gá»i háº¯n Äƒn Ä‘iá»ƒm tÃ¢m a."
        //'^CHAP_TEXT',
        //ã€ChÆ°Æ¡ng 1:
        '^ã€CHAP_TYPE CHAP_NUM: TITLE',
        //22.
        '^CHAP_NUM\\.$',
        //Äáº¡i phá»¥ng gÃµ mÃµ cáº§m canh nhÃ¢n chi xanh miáº¿t #1 tÃ¡c giáº£: Há»‘ ni
        '^NAME #CHAP_NUM',
        //(háº¡)
        '^\\(HALF_TEXT\\)$',
        //"Báº¡n gÃ¡i Ä‘á»‡ Ä‘á»‡" 11
        '^"NAME" CHAP_NUM$',
        //Thá»© 1 tiáº¿t tay nghá» tiá»ƒu tá»­ & Uzumaki Naruto
        '^(Äá»‡|thá»©) HALF_NUM HALF_TYPE TITLE$',
        //Tiáº¿t thá»© hai Hyuga Hinata
        //Tiáº¿t thá»© nÄƒm: Naruto cá»±c khá»• ngÃ y
        '^HALF_TYPE thá»© HALF_TEXT[:]? TITLE$',
        //Thá»© báº£y tiáº¿t trÄƒm hÃ o Tiá»ƒu Anh! Má»™t cÃ¢u báº¡ch cáº¥p
        //Thá»© sÃ¡u tiáº¿t: Hinata cá»±c khá»• ngÃ y
        //Äá»‡ tháº­p nháº¥t tiáº¿t Sasuke xanh biáº¿c nÃ´ thuá»™c tÃ­nh chuyá»‡n lá»›n háº¥p thá»¥ Ã¡nh sÃ¡ng!
        '^(Äá»‡|thá»©) HALF_TEXT HALF_TYPE[:]? TITLE$',
        //ã€hÃ o hiá»‡p xanh biáº¿c truyá»‡n IIã€‘
        '^ã€NAME BOOK_TEXTã€‘$',
        //ã€chÆ°Æ¡ng káº¿t, (LÃ£ phÃ m thá»‹ giÃ¡c)ã€‘
        '^ã€CHAP_TYPE CHAP_TEXT, \\(TITLE',
        //ã€chÆ°Æ¡ng káº¿tã€‘
        '^ã€CHAP_TYPE CHAP_TEXTã€‘$',
        //Kiá»u thÃª chuyá»‡n xÆ°a (nháº¥t)
        '^NAME \\(CHAP_TEXT\\)$',
        //ã€Š kiá»u thÃª chuyá»‡n xÆ°a ã€‹2
        '^ã€Š NAME ã€‹CHAP_NUM$',
        //#3 ChÆ°Æ¡ng 3: DÆ°á»›i Ã¡nh trÄƒng chinh phá»¥c
        '^#\\d+ ChÆ°Æ¡ng CHAP_NUM: TITLE',
        //NÃ³n xanh chiáº¿n tháº§n ngÆ°á»i á»Ÿ rá»ƒ (ChÆ°Æ¡ng 5: phá»‘i Ä‘á»“ báº£n)
        '^NAME \\(ChÆ°Æ¡ng CHAP_NUM: TITLE\\)',
        //Phá»¥c 63 chÆ°Æ¡ng
        '^Phá»¥c CHAP_NUM chÆ°Æ¡ng',
        //LÃ£o bÃ  Tuyáº¿t Nhi Ä‘á»•i thÃª tráº£i qua (tháº­p tam)
        '^NAME \\(CHAP_TEXT\\)TITLE',
        //â€” máº¹ vÃº to ngÆ°á»i vá»£ khuÃª máº­t 84 cÃ¹ng máº¹ cÃ¹ng ná»¯ nhi
        '^[^\\p{L}]* NAME CHAP_NUM TITLE',
        //ã€30, khÃºc cuá»‘iã€‘
        '^ã€CHAP_NUM, TITLEã€‘$',
        //ã€hai mÆ°Æ¡i báº£y ba ngÆ°á»i háº¡nh phÃºc (thÆ°á»£ng)ã€‘
        '^ã€CHAP_TEXT,? TITLE \\(HALF_TEXT\\)ã€‘$',
        //ã€hai mÆ°Æ¡i sÃ¡u tÃ¡i kiáº¿n tinh khÃ´ngã€‘
        //ã€hai mÆ°Æ¡i chÃ­n, ba ngÆ°á»i háº¡nh phÃºcã€‘
        '^ã€CHAP_TEXT,? TITLEã€‘$',
        //Hai mÆ°Æ¡i tÆ° du hÃ­ triá»ƒn
        '^CHAP_TEXT TITLE_SHORT$',
        //Thá»© 1 cuá»‘n 1, bá»‹ phiÃªu rá»“i háº£?
        '^thá»© BOOK_NUM BOOK_TYPE CHAP_NUM, TITLE$',
        //â— thá»© 1 chÆ°Æ¡ng â—
        //
        //VÃµ trÃ ng lÃµa thá»ƒ luyá»‡n kiáº¿m, thÃ´i miÃªn tá»± an á»§i â—
        '^â— thá»© CHAP_NUM CHAP_TYPE â—$\\n+TITLEâ—',
        //ká»ƒ ra má»™t cÃ¡i cháº³ng pháº£i thuáº§n khiáº¿t trÆ°á»Ÿng thÃ nh chuyá»‡n xÆ°a ChÆ°Æ¡ng 3: Thiáº¿u ná»¯ báº¯t gian nháº­t kÃ½
        '(?<=\\s\\p{Ll}+\\s)CHAP_TYPE CHAP_NUM',
        //"BÃ­ máº­t nháº¡c viÃªn" (ChÆ°Æ¡ng 7: HÃ´n ná»­a nÄƒm sau)
        '"NAME" \\(CHAP_TYPE CHAP_NUM: TITLE\\)',
        //Thá»© 01 thiÃªn: Tuyá»‡t sáº¯c gia tá»™c chi cÆ°á»¡ng dÃ¢m (trung)
        'Thá»© CHAP_NUM CHAP_TYPE: TITLE \\(HALF_TEXT\\)',
        //Tiáº¿p theo viáº¿t thá»© 8 chÆ°Æ¡ng sÆ¡ phong mÃ¹i thÆ¡m
        'Tiáº¿p theo viáº¿t thá»© CHAP_NUM CHAP_TYPE TITLE',
        //Thá»© hai nÃ³i
        '^Thá»© CHAP_TEXT nÃ³i$',
        //001 ta vÃ  thÃª tá»­ viÃªn viá»‡n
        '^CHAP_NUM TITLE',
      ];
      let matches = [];
      for (let pattern of patterns) {
        let source = pattern
          .replace('NAME', '(?<name>' + [...new Set([name, name.replace('há»‡ liá»‡t', '').trim()])].join('|') + ')')
          .replace('DATE', '\\d+-\\d+-\\d+')
          .replace('SEP', '[ :]')
          .replace('TITLE_SHORT', '(?<titleShort>[^\nã€‘]{1,50}\\.*)')
          .replace('TITLE', '(?<title>[^\nã€‘]+\\.*)')
          .replace('BOOK_TITLE', '(?<bookTitle>[^\nã€‘]+\\.*)')
          .replace('BOOK_TYPE', '(?<bookType>(quyá»ƒn|táº­p|bá»™|cuá»‘n))')
          .replace('BOOK_NUM', `(?<bookNum>${NUMERIC})`)
          .replace('BOOK_TEXT', `(?<bookText>${NUMERIC_WORDS})`)
          .replace('HALF_TYPE', `(?<halfType>(tiáº¿t))`)
          .replace('HALF_NUM', `(?<halfNum>${NUMERIC})`)
          .replace('HALF_TEXT', `(?<halfText>(?<=\\()(thÆ°á»£ng|trung|háº¡|${NUMERIC_WORDS})(?=\\))|(?<=thá»© )${NUMERIC_WORDS})`)
          .replace('CHAP_TYPE', '(?<chapType>(chÆ°Æ¡ng|há»“i|thiÃªn))')
          .replace('CHAP_NUM_DECIMAL', `(?<chapNum>${NUMERIC_DECIMAL})`)
          .replace('CHAP_NUM', `(?<chapNum>${NUMERIC})`)
          .replace('CHAP_TEXT', `(?<chapText>cuá»‘i|káº¿t|${NUMERIC_WORDS})`);
        let regex = new RegExp(source, 'gimu');
        let result = [...text.matchAll(regex)];
        console.debug({ pattern, regex, result });
        matches.push(...result.map(m => ({ pattern, regex, index: m.index, ...m.groups, text: m[0] })));
      }
      matches.forEach(m => {
        for (let f of ['chapText', 'bookText', 'halfText']) {
          if (m[f]) {
            if (/^[MDCLXVI]+$/i.test(m[f])) {
              let val = {
                I: 1,
                V: 5,
                X: 10,
                L: 50,
                C: 100,
                D: 500,
                M: 1000,
              };
              let totalValue = 0;
              let value = 0;
              let prev = 0;
              for (let c of m[f]) {
                let current = val[c];
                if (current > prev) {
                  // Undo the addition that was done, turn it into subtraction
                  totalValue -= 2 * value;
                }
                if (current != prev) { // Different symbol?
                  value = 0; // reset the sum for the new symbol
                }
                value += current; // keep adding same symbols
                totalValue += current;
                prev = current;
              }
              m[f] = totalValue;
            } else {
              let c = m[f].toLowerCase();
              let vn = {
                'mÆ°Æ¡i$|(?<=.)(tháº­p|bÃ¡ch|thiÃªn|váº¡n)$': 0,
                'mÆ°Æ¡i': '',
                '(mÆ°á»i|tháº­p)(?=.+)|m[á»™á»‘]t|nháº¥t': 1,
                'hai|nhá»‹': 2,
                'ba|tam': 3,
                'bá»‘n|tá»©': 4,
                '[nl]Äƒm|ngÅ©': 5,
                'sÃ¡u|lá»¥c': 6,
                'báº£y|tháº¥t': 7,
                'tÃ¡m|bÃ¡t': 8,
                'chÃ­n|cá»­u': 9,
                'mÆ°á»i|tháº­p': 10,
              };
              Object.entries(vn).forEach(([w, i]) => {
                w = new RegExp(w, 'gimu');
                c = c.replace(w, i);
              });
              c = c.replace(/\s/g, '');
              c = Number.parseInt(c);
              if (!Number.isNaN(c)) m[f] = Number.parseInt(c);
            }
          }
        }
        for (let f of ['chapNum', 'bookNum']) {
          if (m[f]) {
            m[f] = m[f].split('.').map(Number).join('.');
          }
        }
      });
      matches.sort((a, z) => a.index - z.index);
      debug({ matches });

      if (matches.length < 2) {
        let paragraphsPerChapter = 60;
        let pattern = '(.*\n){1,' + paragraphsPerChapter + '}';
        let regex = new RegExp(pattern, 'gimu')
        let result = [...text.matchAll(regex)];
        matches = result.map(m => ({ pattern, regex, index: m.index, ...m.groups, text: m[0] }));
      }

      let chapters = [];
      matches.forEach(m => {
        chapters.push(Chapter(m, { chapters, filename, text }));
      });

      dedupeChapters(chapters);
      lockContinuous(chapters);
      mergeShortChapters(chapters, 1000);
      cleanupChapters(chapters);
      addPrologue(chapters, filename, text);

      return chapters;
    }

    function mergeBehind(chapters, i, reason) {
      // chapters[i].endIndex = chapters[i+1].endIndex;
      let [ch, ci] = [chapters[i-1], chapters[i]];
      let c;
      if (!ch.chapNo && ci.chapNo) c = ci;
      else if (ch.chapNo == ci.chapNo) {
        if (!ch._.title && ci._.title) c = ci;
      }
      //console.log('merge', [ch._.text, ci._.text], 'because', reason, c == ci, { ch, ci });
      if (c) {
        Object.assign(ch._, {
          title: c._.title,
          chapNo: c._.chapNo,
          chapText: c._.chapText,
          bookNo: c._.bookNo,
          bookText: c._.bookText,
          bookType: c._.bookType,
          halfNo: c._.halfNo,
          halfText: c._.halfText,
          halfType: c._.halfType,
        });
      }
      chapters.splice(i, 1);
      //console.log('  ->', [ch._.text])
      ch.merged++;
    }

    function dedupeChapters(chapters) {
      for (let i = chapters.length - 1; i > 0; i--) {
        let h = i-1;
        let [ch, ci] = [chapters[h], chapters[i]];
        let shouldMerge = false;
        if (ch.startIndex == ci.startIndex) shouldMerge = true;
        if (ch.chapNo != null && ch.chapNo == ci.chapNo && ch.half == ci.half) shouldMerge = true;
        if (shouldMerge) {
          // console.log('dedupe', [ch.title, ci.title]);
          mergeBehind(chapters, i, 'dedupe');
        }
      }
    }

    function lockContinuous(chapters, lookupRange = 5) {
      //look behind
      for(let i = 1; i < chapters.length; i++) {
        let ci = chapters[i];
        if(!ci.chapNo) continue;
        console.group('Look behind', ci.chapNo);
        console.log(ci.chapNo, ci.title);
        for(let h = i - 1; h >= 0 && h >= i - lookupRange; h--) {
          let ch = chapters[h];
          let shouldLock = false;
          if(ch.chapNo + 1 == ci.chapNo) shouldLock = true;
          else if((ch.chapNo == ci.chapNo) && ch.halfNo && (ch.halfNo + 1 == ci.halfNo)) shouldLock = true;
          if(shouldLock) {
            console.info('Lock', { ch: ch.title, ci: ci.title });
            ch.locked = true;
            ci.locked = true;
            break;
          }
        }
        console.groupEnd();
      }
      //look ahead
      for(let i = chapters.length - 2; i >= 0; i--) {
        let ci = chapters[i];
        if(!ci.chapNo) continue;
        if(ci.locked) continue;
        console.group('Look ahead', ci.chapNo);
        console.log(ci.chapNo, ci.title);
        for(let j = i + 1; j < chapters.length && j < i + lookupRange; j++) {
          let cj = chapters[j];
          let shouldLock = false;
          if(ci.chapNo + 1 == cj.chapNo) shouldLock = true;
          else if((ci.chapNo == cj.chapNo) && ci.halfNo && (ci.halfNo + 1 == cj.halfNo)) shouldLock = true;
          if(shouldLock) {
            console.info('Lock', { ci: ci.title, cj: cj.title });
            ci.locked = true;
            cj.locked = true;
            break;
          }
        }
        console.groupEnd();
      }
    }

    function cleanupChapters(chapters) {
      let phienNgoai = c => /phiÃªn ngoáº¡i/iu.test(c._.title);

      // debug({chapters})
      let i = 1;
      while (i < chapters.length - 1) {
        let [ch, ci, cj] = [chapters[i-1], chapters[i], chapters[i+1]];
        let shouldMerge = false;
        //ci is not continuity of ch
        if (ch.chapNo != null && ci.chapNo != null && (ch.chapNo + 1 != ci.chapNo)) {
          // console.log('phien ngoai', [ch._.title, ci._.title]);
          if (phienNgoai(ch) != phienNgoai(ci) || ch.half != ci.half) {
            i++;
            continue;
          }
          if (!cj && !/phiÃªn ngoáº¡i/iu.test(ci._.title)) {
            //ci is the last chapter, can merge
            shouldMerge = true;
          } else {
            //find continuity of ch
            for (let j = i + 1; j <= i + 3 && j < chapters.length; j++) {
              cj = chapters[j];
              // console.log(ch.chapNo, cj.chapNo);
              if (cj.chapNo != null && (ch.chapNo + 1 == cj.chapNo)) {
                shouldMerge = true;
                break;
              }
            }
          }
        }
        if (shouldMerge) {
          //console.debug('cleanupChapters', ch.chapNo, '<-', ci.chapNo, cj?.chapNo);
          mergeBehind(chapters, i, 'cleanup');
        } else {
          i++;
        }
      }
    }

    function mergeShortChapters(chapters, minLength = 2_000) {
      for (let i = chapters.length - 1; i > 0; i--) {
        let [h, j] = [i-1, i+1];
        let [ch, ci, cj] = [chapters[h], chapters[i], chapters[j]];
        if ((ci.length / ci.merged) < minLength) {
          if(ci.locked) continue;
          console.group('merge');
          console.warn(ci.id);
          let fields = [];
          if (ci.bookNo) fields.push('bookNo');
          if (ci.chapter != null) fields.push('chapter');
          if (ci.half) fields.push('half');
          if (fields.every(f => ch[f] == ci[f])) {
            console.log(chapters, i, 'short and dupe of prev');
            mergeBehind(chapters, i, 'short and dupe of prev');
          } else if (cj && fields.every(f => cj[f] == ci[f])) {
            console.log(chapters, j, 'short and dupe of next');
            mergeBehind(chapters, j, 'short and dupe of next');
          } else if (fields.length == 0 || (fields.length == 1 && fields[0] == 'chapter')) {
            if (ci._.name && cj) {
              console.log(chapters, j, 'short with name');
              mergeBehind(chapters, j, 'short with name');
            } else {
              console.log('short', { ch: ch.title, ci: ci.title, cj: cj.title });
              mergeBehind(chapters, i, 'short');
            }
          }
          console.groupEnd();
        }
      }
    }

    function mergeShortChapters1(chapters, minLength = 2e3) {
      let isShort = chapter => ((chapter.endIndex - chapter.startIndex) <= minLength);
      let isLong = chapter => !isShort(chapter);
      //delete all first short chapters, they belongs to prologue
      let firstLongChapterIndex = chapters.findIndex(isLong);
      chapters.splice(0, firstLongChapterIndex);
      //merge short chapters to next long chapter
      let short;
      while((short = chapters.find(isShort))) {
        let shortIndex = chapters.indexOf(short);
        let long = chapters.find((chapter, index) => isLong(chapter) && index >= shortIndex);
        let longIndex = chapters.indexOf(long);
        if (long) {
          short.endIndex = long.endIndex;
          chapters.splice(shortIndex, longIndex - shortIndex);
        } else {
          //merge last short chapters to previous long chapter
          long = chapters[shortIndex - 1];
          if (long) {
            long.endIndex = text.length;
            chapters.length = shortIndex;
          }
          break;
        }
      }
    }

    function addPrologue(chapters, filename, text) {
      //extract prologue
      let prologue = text.slice(0, chapters[0]?.startIndex ?? -1).trim();
      if(prologue) {
        chapters.unshift(Chapter({
          title: filename,
          index: 0,
        }, { chapters, filename, text }));
      }
    }

    function extractChapters1(filename, text, { name }) {
      let debug = true;
      debug && console.log({ name });
      //let chapterPattern = /^\s*\[?\s*(?:chapter)?\s*:?\s*Thá»©\s+\w+(\s*-\s*\d+)?\s+chÆ°Æ¡ng\b.*|\bChÆ°Æ¡ng\s+\d+\s*:?.*|^(?:\d+\s*\.?\s*)+$|^\s*\d+\s+ChÆ°Æ¡ng\s*:?\s*|^ã€.*?ã€‘\([\d-]+\)$|^ã€.*?ã€‘\s*bá»™(\s+\d+)+$|^\d+[.!].*|^\s*\d+(\s*-\s*\d+)?\s*$|^[-]+$/gimu;
      let certainPatterns = [
        /^chÆ°Æ¡ng \d+$/,
        /^chÆ°Æ¡ng \d+:/,
        /^â€” ?chÆ°Æ¡ng \d+:.*? ?â€”/,
        /^chÆ°Æ¡ng (cuá»‘i|káº¿t)/,
        /^tá»± chÆ°Æ¡ng/,
        /^Lá»i dáº«n/,
        /^bá»™ \d+:? chÆ°Æ¡ng \d+/, // bá»™ 01: chÆ°Æ¡ng 05:
        /^thá»© \d+ bá»™ thá»© \d+ chÆ°Æ¡ng/, // thá»© 01 bá»™ thá»© 02 chÆ°Æ¡ng
        /^\d+([\.\s]+\d+)*$/,
        /thá»© \d+ chÆ°Æ¡ng/,
        /^\(\d+\)/,
        /^Há»“i \d+/,
        new RegExp('^ã€' + name + 'ã€‘\\d+$'),
        new RegExp('^"' + name + '" \\d+$'),
        /^ch\. \d+/,
        /^ ?\[? ?(?:chapter)? ?:? ?Thá»© \w+( ?- ?\d+)? chÆ°Æ¡ng/,
        /^ ?\d+ ChÆ°Æ¡ng ?:? ?/,
        /^ã€.*?ã€‘\([\d-]+\)$/,
        /^ã€.*?ã€‘ ?bá»™( \d+)+$/,
        /^\d+[.!].*/,
        /^ ?\d+( ?- ?\d+)? ?$/,
        /quyá»ƒn (thá»© )?(\d+|(má»™t|hai|ba|bá»‘n|nÄƒm|sÃ¡u|báº£y|tÃ¡m|chÃ­n|(mÆ°á»i( má»™t)?|(hai|ba|bá»‘n|nÄƒm|sÃ¡u|báº£y|tÃ¡m|chÃ­n) mÆ°Æ¡i( má»‘t)?)( (hai|ba|bá»‘n|lÄƒm|sÃ¡u|báº£y|tÃ¡m|chÃ­n))?)) chÆ°Æ¡ng \d.*/,
        /(phiÃªn ngoáº¡i|chÃ­nh vÄƒn) chÆ°Æ¡ng \d+:/,
        /phiÃªn ngoáº¡i .* chÆ°Æ¡ng/,
        /^(thÆ°á»£ng|trung|háº¡) \(\d+\)$/,
        /^(thÆ°á»£ng|trung|háº¡) bá»™/,
      ];
      let loosePatterns = [
        new RegExp('^ã€' + name + 'ã€‘.*$'),
        new RegExp('^"' + name + '".*$'),
        new RegExp('^' + name + ' [\\(\\.:\\d]'),
        /^.*\((thÆ°á»£ng|trung|háº¡)\):?$/, // pháº£n kÃ­ch (thÆ°á»£ng)
        /^([(]?)(nháº¥t|nhá»‹|tam|tá»©|ngÅ©|lá»¥c|tháº¥t|bÃ¡t|cá»­u|tháº­p|(mÆ°á»i) (má»™t|hai|ba|bá»‘n|nÄƒm|sÃ¡u|báº£y|tÃ¡m|chÃ­n|mÆ°Æ¡i))(?=[,:)])([^.]*)$/,
        /^(nháº¥t|nhá»‹|tam|tá»©|ngÅ©|lá»¥c|tháº¥t|bÃ¡t|cá»­u|tháº­p).*/,
        /^\[.*\]$/,
        /^[-â€”* ]+$/,
      ];
      let matches;
      for (let patterns of [certainPatterns, loosePatterns]) {
        let regex = new RegExp('(?:' + patterns.map(p => '(?:' + p.source + ')').join('|') + ').*', 'gimu');
        matches = [...regex[Symbol.matchAll](text)];
        debug && console.log({ regex, matches })
        if (matches.length > 0) break;
      }
      let chapters = matches.map((match, i) => {
        let startIndex = text.lastIndexOf('\n', match.index);
        if (startIndex == -1) startIndex = 0;
        let endIndex = text.length;
        if (matches[i+1]) endIndex = text.lastIndexOf('\n', matches[i+1].index);
        let title = match[0].trim();
        if (/^[-â€”]+$/.test(title)) title = `-ChÆ°Æ¡ng ${i+1}-`;
        title = title.replace(new RegExp('^ã€(' + name + ')ã€‘\s*', 'i'), '');
        title = title.replace(new RegExp('^"(' + name + ')"\s*', 'i'), '');
        title = title.replace(new RegExp('^(' + name + ')\s*', 'i'), '');
        return {
          title,
          startIndex,
          endIndex,
        }
      });

      return mergeChapters(chapters, filename, text);
    }

    function slug(s) {
      s = latinize(s);
      s = s.replace(/\W+/g, '-');
      s = s.replace(/^-+|-+$/g, '');
      s = s.toLowerCase();
      return s;
    }

    function latinize(s) {
      s = s.replace(/[ÃÄ‚áº®áº¶áº°áº²áº´ÇÃ‚áº¤áº¬áº¦áº¨áºªÃ„ÇžÈ¦Ç áº È€Ã€áº¢È‚Ä€Ä„Ã…Çºá¸€ÈºÃƒâ±¯á´€]/g, 'A');
      s = s.replace(/[êœ²]/g, 'AA');
      s = s.replace(/[Ã†Ç¼Ç¢á´]/g, 'AE');
      s = s.replace(/[êœ´]/g, 'AO');
      s = s.replace(/[êœ¶]/g, 'AU');
      s = s.replace(/[êœ¸êœº]/g, 'AV');
      s = s.replace(/[êœ¼]/g, 'AY');
      s = s.replace(/[á¸‚á¸„Æá¸†ÉƒÆ‚Ê™á´ƒÐ‘]/g, 'B');
      s = s.replace(/[Ä†ÄŒÃ‡á¸ˆÄˆÄŠÆ‡È»êœ¾á´„]/g, 'C');
      s = s.replace(/[ÄŽá¸á¸’á¸Šá¸ŒÆŠá¸ŽÇ²Ç…ÄÃÆ‹ê¹á´…Ð”]/g, 'D');
      s = s.replace(/[Ç±Ç„]/g, 'DZ');
      s = s.replace(/[Ã‰Ä”ÄšÈ¨á¸œÃŠáº¾á»†á»€á»‚á»„á¸˜Ã‹Ä–áº¸È„ÃˆáººÈ†Ä’á¸–á¸”Ä˜É†áº¼á¸šÆÆŽá´‡â±»Ð•Ð­]/g, 'E');
      s = s.replace(/[êª]/g, 'ET');
      s = s.replace(/[á¸žÆ‘ê»êœ°Ð¤]/g, 'F');
      s = s.replace(/[Ç´ÄžÇ¦Ä¢ÄœÄ Æ“á¸ Ç¤ê½É¢Ê›Ð“Ò]/g, 'G');
      s = s.replace(/[á¸ªÈžá¸¨Ä¤â±§á¸¦á¸¢á¸¤Ä¦ÊœÐ¥]/g, 'H');
      s = s.replace(/[ÃÄ¬ÇÃŽÃá¸®Ä°á»ŠÈˆÃŒá»ˆÈŠÄªÄ®Æ—Ä¨á¸¬Ð†ÉªÐ™Ð«Ð˜]/g, 'I');
      s = s.replace(/[êž‚Å”Å˜Å–á¹˜á¹šá¹œÈÈ’á¹žÉŒâ±¤ÊÊ€á´™á´šÐ ]/g, 'R');
      s = s.replace(/[êž„Åšá¹¤Å á¹¦ÅžÅœÈ˜á¹ á¹¢á¹¨êœ±Ð¡]/g, 'S');
      s = s.replace(/[êž†Å¤Å¢á¹°ÈšÈ¾á¹ªá¹¬Æ¬á¹®Æ®Å¦á´›Ð¢]/g, 'T');
      s = s.replace(/[ê¬]/g, 'IS');
      s = s.replace(/[Ä´Éˆá´Š]/g, 'J');
      s = s.replace(/[á¸°Ç¨Ä¶â±©ê‚á¸²Æ˜á¸´ê€ê„á´‹Ðš]/g, 'K');
      s = s.replace(/[Ä¹È½Ä½Ä»á¸¼á¸¶á¸¸â± êˆá¸ºÄ¿â±¢ÇˆÅêž€ÊŸá´ŒÐ›]/g, 'L');
      s = s.replace(/[Ç‡]/g, 'LJ');
      s = s.replace(/[á¸¾á¹€á¹‚â±®Æœá´Ðœ]/g, 'M');
      s = s.replace(/[ÅƒÅ‡Å…á¹Šá¹„á¹†Ç¸Æá¹ˆÈ Ç‹Ã‘É´á´ŽÐ]/g, 'N');
      s = s.replace(/[ÇŠ]/g, 'NJ');
      s = s.replace(/[Ã“ÅŽÇ‘Ã”á»á»˜á»’á»”á»–Ã–ÈªÈ®È°á»ŒÅÈŒÃ’á»ŽÆ á»šá»¢á»œá»žá» ÈŽêŠêŒÅŒá¹’á¹ÆŸÇªÇ¬Ã˜Ç¾Ã•á¹Œá¹ŽÈ¬Æ†á´á´Ðž]/g, 'O');
      s = s.replace(/[Æ¢]/g, 'OI');
      s = s.replace(/[êŽ]/g, 'OO');
      s = s.replace(/[È¢á´•]/g, 'OU');
      s = s.replace(/[á¹”á¹–ê’Æ¤ê”â±£êá´˜ÐŸ]/g, 'P');
      s = s.replace(/[ê˜ê–]/g, 'Q');
      s = s.replace(/[ÃŸ]/g, 'ss');
      s = s.replace(/[É…êžá¹¾Æ²á¹¼á´ Ð’]/g, 'V');
      s = s.replace(/[êœ¨]/g, 'TZ');
      s = s.replace(/[ÃšÅ¬Ç“Ã›á¹¶ÃœÇ—Ç™Ç›Ç•á¹²á»¤Å°È”Ã™á»¦Æ¯á»¨á»°á»ªá»¬á»®È–Åªá¹ºÅ²Å®Å¨á¹¸á¹´á´œÐ£]/g, 'U');
      s = s.replace(/[ê ]/g, 'VY');
      s = s.replace(/[áº‚Å´áº„áº†áºˆáº€â±²á´¡]/g, 'W');
      s = s.replace(/[áºŒáºŠ]/g, 'X');
      s = s.replace(/[ÃÅ¶Å¸áºŽá»´á»²Æ³á»¶á»¾È²ÉŽá»¸Ê]/g, 'Y');
      s = s.replace(/[Ð‡]/g, 'YI');
      s = s.replace(/[Å¹Å½áºâ±«Å»áº’È¤áº”Æµá´¢Ð—]/g, 'Z');
      s = s.replace(/[Ãž]/g, 'TH');
      s = s.replace(/[Ä²]/g, 'IJ');
      s = s.replace(/[Å’É¶]/g, 'OE');
      s = s.replace(/[Ã¡Äƒáº¯áº·áº±áº³áºµÇŽÃ¢áº¥áº­áº§áº©áº«Ã¤ÇŸÈ§Ç¡áº¡ÈÃ áº£ÈƒÄÄ…á¶áºšÃ¥Ç»á¸â±¥Ã£Éâ‚ÐÐ°]/g, 'a');
      s = s.replace(/[êœ³]/g, 'aa');
      s = s.replace(/[Ã¦Ç½Ç£á´‚]/g, 'ae');
      s = s.replace(/[êœµ]/g, 'ao');
      s = s.replace(/[êœ·]/g, 'au');
      s = s.replace(/[êœ¹êœ»]/g, 'av');
      s = s.replace(/[êœ½]/g, 'ay');
      s = s.replace(/[á¸ƒá¸…É“á¸‡áµ¬á¶€Æ€ÆƒÐ±]/g, 'b');
      s = s.replace(/[ÉµÃ³ÅÇ’Ã´á»‘á»™á»“á»•á»—Ã¶È«È¯È±á»Å‘ÈÃ²á»Æ¡á»›á»£á»á»Ÿá»¡Èê‹êâ±ºÅá¹“á¹‘Ç«Ç­Ã¸Ç¿Ãµá¹á¹È­É”á¶—á´‘á´“â‚’Ð¾]/g, 'o');
      s = s.replace(/[Ä‡ÄÃ§á¸‰Ä‰É•Ä‹ÆˆÈ¼â†„êœ¿]/g, 'c');
      s = s.replace(/[Äá¸‘á¸“È¡á¸‹á¸É—á¶‘á¸áµ­á¶Ä‘É–ÆŒÃ°êºÐ´]/g, 'd');
      s = s.replace(/[Ä±Ã­Ä­ÇÃ®Ã¯á¸¯á»‹È‰Ã¬á»‰È‹Ä«Ä¯á¶–É¨Ä©á¸­Ñ–á´‰áµ¢Ð¹Ñ‹Ð¸]/g, 'i');
      s = s.replace(/[È·ÉŸÊ„Ç°ÄµÊÉ‰â±¼]/g, 'j');
      s = s.replace(/[Ç³Ç†]/g, 'dz');
      s = s.replace(/[Ã©Ä•Ä›È©á¸Ãªáº¿á»‡á»á»ƒá»…á¸™Ã«Ä—áº¹È…Ã¨áº»È‡Ä“á¸—á¸•â±¸Ä™á¶’É‡áº½á¸›É›á¶“É˜Çâ‚‘ÐµÑ]/g, 'e');
      s = s.replace(/[ê«]/g, 'et');
      s = s.replace(/[á¸ŸÆ’áµ®á¶‚ê¼Ñ„]/g, 'f');
      s = s.replace(/[ÇµÄŸÇ§Ä£ÄÄ¡É á¸¡á¶ƒÇ¥áµ¹É¡áµ·Ð³Ò‘]/g, 'g');
      s = s.replace(/[á¸«ÈŸá¸©Ä¥â±¨á¸§á¸£á¸¥É¦áº–Ä§É¥Ê®Ê¯Ñ…]/g, 'h');
      s = s.replace(/[Æ•]/g, 'hv');
      s = s.replace(/[êžƒÅ•Å™Å—á¹™á¹›á¹È‘É¾áµ³È“á¹ŸÉ¼áµ²á¶‰ÉÉ½É¿É¹É»Éºâ±¹áµ£Ñ€]/g, 'r');
      s = s.replace(/[êž…Å¿áºœáº›áºÅ›á¹¥Å¡á¹§ÅŸÅÈ™á¹¡á¹£á¹©Ê‚áµ´á¶ŠÈ¿Ñ]/g, 's');
      s = s.replace(/[êž‡Å¥Å£á¹±È›È¶áº—â±¦á¹«á¹­Æ­á¹¯áµµÆ«ÊˆÅ§Ê‡Ñ‚]/g, 't');
      s = s.replace(/[ê­]/g, 'is');
      s = s.replace(/[á¸±Ç©Ä·â±ªêƒá¸³Æ™á¸µá¶„êê…ÊžÐº]/g, 'k');
      s = s.replace(/[ÄºÆšÉ¬Ä¾Ä¼á¸½È´á¸·á¸¹â±¡ê‰á¸»Å€É«á¶…É­Å‚êžÐ»]/g, 'l');
      s = s.replace(/[Ç‰]/g, 'lj');
      s = s.replace(/[á¸¿á¹á¹ƒÉ±áµ¯á¶†É¯É°Ð¼]/g, 'm');
      s = s.replace(/[Å„ÅˆÅ†á¹‹Èµá¹…á¹‡Ç¹É²á¹‰Æžáµ°á¶‡É³Ã±Ð½]/g, 'n');
      s = s.replace(/[ÇŒ]/g, 'nj');
      s = s.replace(/[Æ£]/g, 'oi');
      s = s.replace(/[ê]/g, 'oo');
      s = s.replace(/[È£]/g, 'ou');
      s = s.replace(/[á¹•á¹—ê“Æ¥áµ±á¶ˆê•áµ½ê‘Ð¿]/g, 'p');
      s = s.replace(/[ê™Ê É‹ê—]/g, 'q');
      s = s.replace(/[á´ÃºÅ­Ç”Ã»á¹·Ã¼Ç˜ÇšÇœÇ–á¹³á»¥Å±È•Ã¹á»§Æ°á»©á»±á»«á»­á»¯È—Å«á¹»Å³á¶™Å¯Å©á¹¹á¹µáµ¤Ñƒ]/g, 'u');
      s = s.replace(/[áµºÃ¾]/g, 'th');
      s = s.replace(/[á´”Å“]/g, 'oe');
      s = s.replace(/[ÊŒâ±´êŸá¹¿Ê‹á¶Œâ±±á¹½áµ¥Ð²]/g, 'v');
      s = s.replace(/[ÊáºƒÅµáº…áº‡áº‰áºâ±³áº˜]/g, 'w');
      s = s.replace(/[ÊŽÃ½Å·Ã¿áºá»µá»³Æ´á»·á»¿È³áº™Éá»¹]/g, 'y');
      s = s.replace(/[êœ©]/g, 'tz');
      s = s.replace(/[áµ«]/g, 'ue');
      s = s.replace(/[ê¸]/g, 'um');
      s = s.replace(/[ê¡]/g, 'vy');
      s = s.replace(/[áºáº‹á¶â‚“]/g, 'x');
      s = s.replace(/[Ñ—]/g, 'yi');
      s = s.replace(/[ÅºÅ¾áº‘Ê‘â±¬Å¼áº“È¥áº•áµ¶á¶ŽÊÆ¶É€Ð·]/g, 'z');
      s = s.replace(/[ï¬€]/g, 'ff');
      s = s.replace(/[ï¬ƒ]/g, 'ffi');
      s = s.replace(/[ï¬„]/g, 'ffl');
      s = s.replace(/[ï¬]/g, 'fi');
      s = s.replace(/[ï¬‚]/g, 'fl');
      s = s.replace(/[Ä³]/g, 'ij');
      s = s.replace(/[ï¬†]/g, 'st');
      s = s.replace(/[Ð]/g, 'YO');
      s = s.replace(/[Ð¦]/g, 'TS');
      s = s.replace(/[Ð¨]/g, 'SH');
      s = s.replace(/[Ð©]/g, 'SCH');
      s = s.replace(/[ÐªÑŠÐ¬ÑŒ]/g, '\'');
      s = s.replace(/[Ñ‘]/g, 'yo');
      s = s.replace(/[Ñ†]/g, 'ts');
      s = s.replace(/[Ñˆ]/g, 'sh');
      s = s.replace(/[Ñ‰]/g, 'sch');
      s = s.replace(/[Ð–]/g, 'ZH');
      s = s.replace(/[Ð¶]/g, 'zh');
      s = s.replace(/[Ð¯]/g, 'Ya');
      s = s.replace(/[Ð§]/g, 'CH');
      s = s.replace(/[Ð®]/g, 'YU');
      s = s.replace(/[Ñ]/g, 'ya');
      s = s.replace(/[Ñ‡]/g, 'ch');
      s = s.replace(/[ÑŽ]/g, 'yu');
      return s;
    }

    function titleizeHumanName(s, minOccurence = 10, occurenceThreshold = 0.8) {
      let debug = false;
      let pattern = /(?:(?<pre>\p{Ll}+)[ ]+)?(?<name>[\p{Lu}A-Z]\p{Ll}+(?:[ ]+\p{Lu}\p{Ll}+)?)(?:[ ]+(?<post>\p{Ll}+))?/gu;
      let counts = {};
      let match;
      let titleize = s => s.replace(/(?<=^|[^\p{L}])\p{L}/gu, s => s.toUpperCase());
      let c = 0;
      while ((match = pattern.exec(s))) {
        if (++c < 10) debug && console.log({ match });
        let { pre, name, post } = match.groups;
        if (!counts[name]) counts[name] = { total: 0, pre: {}, post: {} };
        counts[name].total += 1;
        if (pre) {
          if (!counts[name].pre[pre]) counts[name].pre[pre] = 0;
          counts[name].pre[pre] += 1;
        }
        if (post) {
          if (!counts[name].post[post]) counts[name].post[post] = 0;
          counts[name].post[post] += 1;
        }
      }
      debug && console.dir(counts);
      analyze: for (let [name, { total, pre, post }] of Object.entries(counts)) {
        if (total < minOccurence) {
          debug && console.debug(name, 'is too few .. IGNORE', { total });
          continue analyze;
        }
        for (let [prefix, prefixCount] of Object.entries(pre)) {
          if (prefixCount / total >= occurenceThreshold) {
            debug && console.warn(name, '->', titleize(prefix), name, { total, prefixCount });
            s = s.replace(new RegExp(prefix + '\\s+' + name, 'gu'), titleize);
            continue analyze;
          }
        }
        for (let [postfix, postfixCount] of Object.entries(post)) {
          if (postfixCount / total >= occurenceThreshold) {
            debug && console.warn(name, '->', titleize(postfix), name, { total, postfixCount });
            s = s.replace(new RegExp(name + '\\s+' + postfix, 'gu'), titleize);
            continue analyze;
          }
        }
      }
      return s;
    }

    function debug(...args) {
      // return;
      if (args.length == 1) {
        console.table(Object.values(args[0])[0]);
      } else {
        console.info(...args);
      }
    }

    function getColorScheme() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) return 'dark';
      return 'light';
    }

    function buildRegex(patterns, placeholders, flags) {
      patterns = patterns.filter(Boolean).map((p, i) => `(?<Case${i+1}>${p.source || p})`).join('|');
      let counts = Object.fromEntries(Object.keys(placeholders).map(k => [k, 0]));
      for(let i = 1; i <= 10; i++) {
        for(let [p, r] of Object.entries(placeholders)) {
          patterns = patterns.replaceAll(`{${p}}`, () => `(?<${p}${++counts[p]}>${r.source || r})`);
        }
      }
      return new RegExp(patterns, flags);
    }

    function simpleCache({ key, getValue, getHash, fallbackValue }) {
      try {
        let cache = globalThis.__simpleCache || (globalThis.__simpleCache = {});
        let hash = getHash();
        if (!(key in cache) || cache[key].hash != hash) {
          cache[key] = { value: getValue(), hash };
        }
        return cache[key].value;
      } catch {
        return fallbackValue;
      }
    }

    function titleCase(s) {
      return s.toLowerCase().replace(/(?<=^|[^\p{L}])./gu, c => c.toUpperCase());
    }

    function memoize(f) {
      let memoized = _.memoize(f, (...args) => JSON.stringify(args));
      globalThis[f.name] = memoized;
      return memoized;
    }

    function getCase(word) {
      if (word == word.toUpperCase()) return 'upper';
      if (word == word.toLowerCase()) return 'lower';
      if (word[0] == word[0].toUpperCase()) return 'title';
    }

    function toCase(word, _case) {
      if (_case == 'upper') return word.toUpperCase();
      if (_case == 'lower') return word.toLowerCase();
      if (_case == 'title') return titleCase(word);
      return word;
    }

    memoize(function useCase(src, dst) {
      if (getCase(src) == 'lower' && getCase(dst) == 'lower') return titleCase(dst);
      let srcWords = src.split(' ');
      let dstWords = dst.split(' ');
      if (srcWords.length == dstWords.length) {
        let cases = srcWords.map((srcWord, i) => {
          if (getCase(srcWord) != getCase(dstWords[i])) return getCase(dstWords[i]);
        });
        return function applyCase(s) {
          return s.split(' ').map((word, i) => toCase(dstWords[i], cases[i] || getCase(word))).join(' ');
        }
      }
      return dst;
    });
  </script>
</body>
</html>
